<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE DuplicateRecordFields #-}
<span class="lineno">    2 </span>{-# LANGUAGE OverloadedStrings #-}
<span class="lineno">    3 </span>{-# LANGUAGE QuasiQuotes #-}
<span class="lineno">    4 </span>{-# LANGUAGE RecordWildCards #-}
<span class="lineno">    5 </span>{-# LANGUAGE TypeFamilies #-}
<span class="lineno">    6 </span>
<span class="lineno">    7 </span>{- |
<span class="lineno">    8 </span>Module      : NITTA.Model.ProcessorUnits.IO.SPI
<span class="lineno">    9 </span>Description :
<span class="lineno">   10 </span>Copyright   : (c) Aleksandr Penskoi, 2019
<span class="lineno">   11 </span>License     : BSD3
<span class="lineno">   12 </span>Maintainer  : aleksandr.penskoi@gmail.com
<span class="lineno">   13 </span>Stability   : experimental
<span class="lineno">   14 </span>-}
<span class="lineno">   15 </span>module NITTA.Model.ProcessorUnits.IO.SPI (
<span class="lineno">   16 </span>    SPI,
<span class="lineno">   17 </span>    anySPI,
<span class="lineno">   18 </span>    Ports (..),
<span class="lineno">   19 </span>    IOPorts (..),
<span class="lineno">   20 </span>    spiMasterPorts,
<span class="lineno">   21 </span>    spiSlavePorts,
<span class="lineno">   22 </span>) where
<span class="lineno">   23 </span>
<span class="lineno">   24 </span>import Data.Aeson
<span class="lineno">   25 </span>import Data.Default
<span class="lineno">   26 </span>import Data.HashMap.Strict qualified as HM
<span class="lineno">   27 </span>import Data.Map.Strict qualified as M
<span class="lineno">   28 </span>import Data.Maybe (fromMaybe, mapMaybe)
<span class="lineno">   29 </span>import Data.Set qualified as S
<span class="lineno">   30 </span>import Data.String.Interpolate
<span class="lineno">   31 </span>import NITTA.Intermediate.Functions
<span class="lineno">   32 </span>import NITTA.Intermediate.Types
<span class="lineno">   33 </span>import NITTA.Model.Problems
<span class="lineno">   34 </span>import NITTA.Model.ProcessorUnits.IO.SimpleIO
<span class="lineno">   35 </span>import NITTA.Model.ProcessorUnits.Types
<span class="lineno">   36 </span>import NITTA.Model.Time
<span class="lineno">   37 </span>import NITTA.Project
<span class="lineno">   38 </span>import NITTA.Utils
<span class="lineno">   39 </span>import Prettyprinter
<span class="lineno">   40 </span>
<span class="lineno">   41 </span>data SPIinterface
<span class="lineno">   42 </span>
<span class="lineno">   43 </span>instance SimpleIOInterface SPIinterface
<span class="lineno">   44 </span>
<span class="lineno">   45 </span>type SPI v x t = SimpleIO SPIinterface v x t
<span class="lineno">   46 </span>
<span class="lineno">   47 </span>anySPI :: Time t =&gt; Int -&gt; Maybe Int -&gt; SPI v x t
<span class="lineno">   48 </span><span class="decl"><span class="istickedoff">anySPI bounceFilter bufferSize =</span>
<span class="lineno">   49 </span><span class="spaces">    </span><span class="istickedoff">SimpleIO</span>
<span class="lineno">   50 </span><span class="spaces">        </span><span class="istickedoff">{ bounceFilter</span>
<span class="lineno">   51 </span><span class="spaces">        </span><span class="istickedoff">, bufferSize</span>
<span class="lineno">   52 </span><span class="spaces">        </span><span class="istickedoff">, receiveQueue = []</span>
<span class="lineno">   53 </span><span class="spaces">        </span><span class="istickedoff">, receiveN = 0</span>
<span class="lineno">   54 </span><span class="spaces">        </span><span class="istickedoff">, isReceiveOver = False</span>
<span class="lineno">   55 </span><span class="spaces">        </span><span class="istickedoff">, sendQueue = []</span>
<span class="lineno">   56 </span><span class="spaces">        </span><span class="istickedoff">, sendN = 0</span>
<span class="lineno">   57 </span><span class="spaces">        </span><span class="istickedoff">, process_ = def</span>
<span class="lineno">   58 </span><span class="spaces">        </span><span class="istickedoff">}</span></span>
<span class="lineno">   59 </span>
<span class="lineno">   60 </span>instance <span class="decl"><span class="istickedoff">IOConnected (SPI v x t)</span></span> where
<span class="lineno">   61 </span>    data IOPorts (SPI v x t)
<span class="lineno">   62 </span>        = SPIMaster
<span class="lineno">   63 </span>            { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">master_mosi</span></span></span> :: OutputPortTag
<span class="lineno">   64 </span>            , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">master_miso</span></span></span> :: InputPortTag
<span class="lineno">   65 </span>            , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">master_sclk</span></span></span> :: OutputPortTag
<span class="lineno">   66 </span>            , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">master_cs</span></span></span> :: OutputPortTag
<span class="lineno">   67 </span>            }
<span class="lineno">   68 </span>        | SPISlave
<span class="lineno">   69 </span>            { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">slave_mosi</span></span></span> :: InputPortTag
<span class="lineno">   70 </span>            , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">slave_miso</span></span></span> :: OutputPortTag
<span class="lineno">   71 </span>            , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">slave_sclk</span></span></span> :: InputPortTag
<span class="lineno">   72 </span>            , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">slave_cs</span></span></span> :: InputPortTag
<span class="lineno">   73 </span>            }
<span class="lineno">   74 </span>        deriving (<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Show</span></span></span></span></span></span>)
<span class="lineno">   75 </span>
<span class="lineno">   76 </span>    <span class="decl"><span class="istickedoff">inputPorts SPISlave{..} = S.fromList [slave_mosi, slave_sclk, slave_cs]</span>
<span class="lineno">   77 </span><span class="spaces">    </span><span class="istickedoff">inputPorts SPIMaster{..} = S.fromList [master_miso]</span></span>
<span class="lineno">   78 </span>
<span class="lineno">   79 </span>    <span class="decl"><span class="istickedoff">outputPorts SPISlave{..} = S.fromList [slave_miso]</span>
<span class="lineno">   80 </span><span class="spaces">    </span><span class="istickedoff">outputPorts SPIMaster{..} = S.fromList [master_mosi, master_sclk, master_cs]</span></span>
<span class="lineno">   81 </span>
<span class="lineno">   82 </span><span class="decl"><span class="istickedoff">spiMasterPorts tag =</span>
<span class="lineno">   83 </span><span class="spaces">    </span><span class="istickedoff">SPIMaster</span>
<span class="lineno">   84 </span><span class="spaces">        </span><span class="istickedoff">{ master_mosi = OutputPortTag $ tag &lt;&gt; &quot;_mosi&quot;</span>
<span class="lineno">   85 </span><span class="spaces">        </span><span class="istickedoff">, master_miso = InputPortTag $ tag &lt;&gt; &quot;_miso&quot;</span>
<span class="lineno">   86 </span><span class="spaces">        </span><span class="istickedoff">, master_sclk = OutputPortTag $ tag &lt;&gt; &quot;_sclk&quot;</span>
<span class="lineno">   87 </span><span class="spaces">        </span><span class="istickedoff">, master_cs = OutputPortTag $ tag &lt;&gt; &quot;_cs&quot;</span>
<span class="lineno">   88 </span><span class="spaces">        </span><span class="istickedoff">}</span></span>
<span class="lineno">   89 </span>
<span class="lineno">   90 </span><span class="decl"><span class="istickedoff">spiSlavePorts tag =</span>
<span class="lineno">   91 </span><span class="spaces">    </span><span class="istickedoff">SPISlave</span>
<span class="lineno">   92 </span><span class="spaces">        </span><span class="istickedoff">{ slave_mosi = InputPortTag $ tag &lt;&gt; &quot;_mosi&quot;</span>
<span class="lineno">   93 </span><span class="spaces">        </span><span class="istickedoff">, slave_miso = OutputPortTag $ tag &lt;&gt; &quot;_miso&quot;</span>
<span class="lineno">   94 </span><span class="spaces">        </span><span class="istickedoff">, slave_sclk = InputPortTag $ tag &lt;&gt; &quot;_sclk&quot;</span>
<span class="lineno">   95 </span><span class="spaces">        </span><span class="istickedoff">, slave_cs = InputPortTag $ tag &lt;&gt; &quot;_cs&quot;</span>
<span class="lineno">   96 </span><span class="spaces">        </span><span class="istickedoff">}</span></span>
<span class="lineno">   97 </span>
<span class="lineno">   98 </span>instance Time t =&gt; Default (SPI v x t) where
<span class="lineno">   99 </span>    <span class="decl"><span class="istickedoff">def = anySPI 0 $ Just 6</span></span>
<span class="lineno">  100 </span>
<span class="lineno">  101 </span>instance (ToJSON v, VarValTime v x t) =&gt; TargetSystemComponent (SPI v x t) where
<span class="lineno">  102 </span>    <span class="decl"><span class="nottickedoff">moduleName _ _ = &quot;pu_spi&quot;</span></span>
<span class="lineno">  103 </span>    <span class="decl"><span class="istickedoff">hardware _tag _pu =</span>
<span class="lineno">  104 </span><span class="spaces">        </span><span class="istickedoff">Aggregate</span>
<span class="lineno">  105 </span><span class="spaces">            </span><span class="istickedoff">Nothing</span>
<span class="lineno">  106 </span><span class="spaces">            </span><span class="istickedoff">[ FromLibrary &quot;spi/pu_slave_spi_driver.v&quot;</span>
<span class="lineno">  107 </span><span class="spaces">            </span><span class="istickedoff">, FromLibrary &quot;spi/spi_slave_driver.v&quot;</span>
<span class="lineno">  108 </span><span class="spaces">            </span><span class="istickedoff">, FromLibrary &quot;spi/i2n_splitter.v&quot;</span>
<span class="lineno">  109 </span><span class="spaces">            </span><span class="istickedoff">, FromLibrary &quot;spi/buffer.v&quot;</span>
<span class="lineno">  110 </span><span class="spaces">            </span><span class="istickedoff">, FromLibrary &quot;spi/bounce_filter.v&quot;</span>
<span class="lineno">  111 </span><span class="spaces">            </span><span class="istickedoff">, FromLibrary &quot;spi/spi_master_driver.v&quot;</span>
<span class="lineno">  112 </span><span class="spaces">            </span><span class="istickedoff">, FromLibrary &quot;spi/n2i_splitter.v&quot;</span>
<span class="lineno">  113 </span><span class="spaces">            </span><span class="istickedoff">, FromLibrary &quot;spi/pu_slave_spi.v&quot;</span>
<span class="lineno">  114 </span><span class="spaces">            </span><span class="istickedoff">, FromLibrary &quot;spi/pu_master_spi.v&quot;</span>
<span class="lineno">  115 </span><span class="spaces">            </span><span class="istickedoff">]</span></span>
<span class="lineno">  116 </span>
<span class="lineno">  117 </span>    <span class="decl"><span class="istickedoff">software tag pu = protocolDescription tag pu &quot;SPI Processor Unit&quot;</span></span>
<span class="lineno">  118 </span>
<span class="lineno">  119 </span>    <span class="decl"><span class="istickedoff">hardwareInstance</span>
<span class="lineno">  120 </span><span class="spaces">        </span><span class="istickedoff">tag</span>
<span class="lineno">  121 </span><span class="spaces">        </span><span class="istickedoff">SimpleIO{bounceFilter, sendN, receiveN}</span>
<span class="lineno">  122 </span><span class="spaces">        </span><span class="istickedoff">UnitEnv</span>
<span class="lineno">  123 </span><span class="spaces">            </span><span class="istickedoff">{ sigClk</span>
<span class="lineno">  124 </span><span class="spaces">            </span><span class="istickedoff">, sigRst</span>
<span class="lineno">  125 </span><span class="spaces">            </span><span class="istickedoff">, sigCycleBegin</span>
<span class="lineno">  126 </span><span class="spaces">            </span><span class="istickedoff">, sigInCycle</span>
<span class="lineno">  127 </span><span class="spaces">            </span><span class="istickedoff">, sigCycleEnd</span>
<span class="lineno">  128 </span><span class="spaces">            </span><span class="istickedoff">, valueIn = Just (dataIn, attrIn)</span>
<span class="lineno">  129 </span><span class="spaces">            </span><span class="istickedoff">, valueOut = Just (dataOut, attrOut)</span>
<span class="lineno">  130 </span><span class="spaces">            </span><span class="istickedoff">, ctrlPorts = Just SimpleIOPorts{..}</span>
<span class="lineno">  131 </span><span class="spaces">            </span><span class="istickedoff">, ioPorts = Just ioPorts</span>
<span class="lineno">  132 </span><span class="spaces">            </span><span class="istickedoff">} =</span>
<span class="lineno">  133 </span><span class="spaces">            </span><span class="istickedoff">[__i|<span class="nottickedoff"><span class="istickedoff"></span></span></span>
<span class="lineno">  134 </span><span class="spaces">                </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ module_ ioPorts } \#</span></span></span>
<span class="lineno">  135 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( .DATA_WIDTH( #{ dataWidth (def :: x) } )</span></span></span>
<span class="lineno">  136 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .ATTR_WIDTH( #{ attrWidth (def :: x) } )</span></span></span>
<span class="lineno">  137 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .BOUNCE_FILTER( #{ show bounceFilter } )</span></span></span>
<span class="lineno">  138 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .DISABLED( #{ if sendN == 0 &amp;&amp; receiveN == 0 then (1 :: Int) else 0 } )</span></span></span>
<span class="lineno">  139 </span><span class="spaces">                        </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">) #{ tag }</span></span></span>
<span class="lineno">  140 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">( .clk( #{ sigClk } )</span></span></span>
<span class="lineno">  141 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .rst( #{ sigRst } )</span></span></span>
<span class="lineno">  142 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .flag_stop( #{ stop } )</span></span></span>
<span class="lineno">  143 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .signal_cycle_begin( #{ sigCycleBegin } )</span></span></span>
<span class="lineno">  144 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .signal_in_cycle( #{ sigInCycle  } )</span></span></span>
<span class="lineno">  145 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .signal_cycle_end( #{ sigCycleEnd } )</span></span></span>
<span class="lineno">  146 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .signal_oe( #{ oe } )</span></span></span>
<span class="lineno">  147 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .signal_wr( #{ wr } )</span></span></span>
<span class="lineno">  148 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .data_in( #{ dataIn } ), .attr_in( #{ attrIn } )</span></span></span>
<span class="lineno">  149 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">, .data_out( #{ dataOut } ), .attr_out( #{ attrOut } )</span></span></span>
<span class="lineno">  150 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">#{ nest 4 $ extIO ioPorts  }</span></span></span>
<span class="lineno">  151 </span><span class="spaces">                    </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">);</span></span></span>
<span class="lineno">  152 </span><span class="spaces">            </span><span class="istickedoff"><span class="nottickedoff"><span class="istickedoff">|]</span></span></span>
<span class="lineno">  153 </span><span class="spaces">            </span><span class="istickedoff">where</span>
<span class="lineno">  154 </span><span class="spaces">                </span><span class="istickedoff">module_ SPISlave{} = &quot;pu_slave_spi&quot; :: Verilog</span>
<span class="lineno">  155 </span><span class="spaces">                </span><span class="istickedoff">module_ SPIMaster{} = &quot;pu_master_spi&quot;</span>
<span class="lineno">  156 </span><span class="spaces">                </span><span class="istickedoff">extIO SPISlave{..} =</span>
<span class="lineno">  157 </span><span class="spaces">                    </span><span class="istickedoff">[__i|</span>
<span class="lineno">  158 </span><span class="spaces">                        </span><span class="istickedoff">, .mosi( #{ slave_mosi } )</span>
<span class="lineno">  159 </span><span class="spaces">                        </span><span class="istickedoff">, .miso( #{ slave_miso } )</span>
<span class="lineno">  160 </span><span class="spaces">                        </span><span class="istickedoff">, .sclk( #{ slave_sclk } )</span>
<span class="lineno">  161 </span><span class="spaces">                        </span><span class="istickedoff">, .cs( #{ slave_cs } )</span>
<span class="lineno">  162 </span><span class="spaces">                    </span><span class="istickedoff">|] ::</span>
<span class="lineno">  163 </span><span class="spaces">                        </span><span class="istickedoff">Verilog</span>
<span class="lineno">  164 </span><span class="spaces">                </span><span class="istickedoff">extIO SPIMaster{..} =</span>
<span class="lineno">  165 </span><span class="spaces">                    </span><span class="istickedoff">[__i|</span>
<span class="lineno">  166 </span><span class="spaces">                        </span><span class="istickedoff">, .mosi( #{ master_mosi } )</span>
<span class="lineno">  167 </span><span class="spaces">                        </span><span class="istickedoff">, .miso( #{ master_miso } )</span>
<span class="lineno">  168 </span><span class="spaces">                        </span><span class="istickedoff">, .sclk( #{ master_sclk } )</span>
<span class="lineno">  169 </span><span class="spaces">                        </span><span class="istickedoff">, .cs( #{ master_cs } )</span>
<span class="lineno">  170 </span><span class="spaces">                    </span><span class="istickedoff">|]</span>
<span class="lineno">  171 </span><span class="spaces">    </span><span class="istickedoff">hardwareInstance _title _pu _env = <span class="nottickedoff">error &quot;internal error&quot;</span></span></span>
<span class="lineno">  172 </span>
<span class="lineno">  173 </span>instance VarValTime v x t =&gt; IOTestBench (SPI v x t) v x where
<span class="lineno">  174 </span>    <span class="decl"><span class="istickedoff">testEnvironmentInitFlag tag _pu = Just $ tag &lt;&gt; &quot;_env_init_flag&quot;</span></span>
<span class="lineno">  175 </span>
<span class="lineno">  176 </span>    <span class="decl"><span class="istickedoff">testEnvironment</span>
<span class="lineno">  177 </span><span class="spaces">        </span><span class="istickedoff">tag</span>
<span class="lineno">  178 </span><span class="spaces">        </span><span class="istickedoff">sio@SimpleIO{process_, bounceFilter}</span>
<span class="lineno">  179 </span><span class="spaces">        </span><span class="istickedoff">UnitEnv</span>
<span class="lineno">  180 </span><span class="spaces">            </span><span class="istickedoff">{ sigClk</span>
<span class="lineno">  181 </span><span class="spaces">            </span><span class="istickedoff">, sigRst</span>
<span class="lineno">  182 </span><span class="spaces">            </span><span class="istickedoff">, ctrlPorts = Just SimpleIOPorts{}</span>
<span class="lineno">  183 </span><span class="spaces">            </span><span class="istickedoff">, ioPorts = Just ioPorts</span>
<span class="lineno">  184 </span><span class="spaces">            </span><span class="istickedoff">}</span>
<span class="lineno">  185 </span><span class="spaces">        </span><span class="istickedoff">TestEnvironment{teCntx = cntx@Cntx{cntxCycleNumber, cntxProcess}, teComputationDuration} =</span>
<span class="lineno">  186 </span><span class="spaces">            </span><span class="istickedoff">let receivedVariablesSeq =</span>
<span class="lineno">  187 </span><span class="spaces">                    </span><span class="istickedoff">mapMaybe</span>
<span class="lineno">  188 </span><span class="spaces">                        </span><span class="istickedoff">( \f -&gt; case castF f of</span>
<span class="lineno">  189 </span><span class="spaces">                            </span><span class="istickedoff">Just Receive{} -&gt; Just $ oneOf $ variables f</span>
<span class="lineno">  190 </span><span class="spaces">                            </span><span class="istickedoff">_ -&gt; Nothing</span>
<span class="lineno">  191 </span><span class="spaces">                        </span><span class="istickedoff">)</span>
<span class="lineno">  192 </span><span class="spaces">                        </span><span class="istickedoff">$ functions process_</span>
<span class="lineno">  193 </span><span class="spaces">                </span><span class="istickedoff">receivedVarsValues = take cntxCycleNumber $ cntxReceivedBySlice cntx</span>
<span class="lineno">  194 </span><span class="spaces">                </span><span class="istickedoff">sendedVariableSeq =</span>
<span class="lineno">  195 </span><span class="spaces">                    </span><span class="istickedoff">mapMaybe</span>
<span class="lineno">  196 </span><span class="spaces">                        </span><span class="istickedoff">( \case</span>
<span class="lineno">  197 </span><span class="spaces">                            </span><span class="istickedoff">(Target v) -&gt; Just v</span>
<span class="lineno">  198 </span><span class="spaces">                            </span><span class="istickedoff">_ -&gt; Nothing</span>
<span class="lineno">  199 </span><span class="spaces">                        </span><span class="istickedoff">)</span>
<span class="lineno">  200 </span><span class="spaces">                        </span><span class="istickedoff">$ getEndpoints process_</span>
<span class="lineno">  201 </span><span class="spaces">                </span><span class="istickedoff">sendedVarsValues = take cntxCycleNumber $ map cycleCntx cntxProcess</span>
<span class="lineno">  202 </span><span class="spaces">                </span><span class="istickedoff">wordWidth = dataWidth (def :: x)</span>
<span class="lineno">  203 </span><span class="spaces">                </span><span class="istickedoff">frameWordCount = max (length receivedVariablesSeq) $ length sendedVariableSeq</span>
<span class="lineno">  204 </span><span class="spaces">                </span><span class="istickedoff">frameWidth = frameWordCount * wordWidth</span>
<span class="lineno">  205 </span><span class="spaces">                </span><span class="istickedoff">timeLag = 10 :: Int</span>
<span class="lineno">  206 </span><span class="spaces">                </span><span class="istickedoff">sendingDuration =</span>
<span class="lineno">  207 </span><span class="spaces">                    </span><span class="istickedoff">max</span>
<span class="lineno">  208 </span><span class="spaces">                        </span><span class="istickedoff">(teComputationDuration + 2)</span>
<span class="lineno">  209 </span><span class="spaces">                        </span><span class="istickedoff">(frameWidth * 2 + bounceFilter + 2)</span>
<span class="lineno">  210 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  211 </span><span class="spaces">                </span><span class="istickedoff">toVerilogLiteral xs =</span>
<span class="lineno">  212 </span><span class="spaces">                    </span><span class="istickedoff">let xs' = map toVerilogLiteral' xs</span>
<span class="lineno">  213 </span><span class="spaces">                        </span><span class="istickedoff">placeholder = replicate (frameWordCount - length xs) [i|#{ wordWidth }'d00|]</span>
<span class="lineno">  214 </span><span class="spaces">                     </span><span class="istickedoff">in hsep $ punctuate &quot;, &quot; (xs' &lt;&gt; placeholder)</span>
<span class="lineno">  215 </span><span class="spaces">                </span><span class="istickedoff">toVerilogLiteral' x</span>
<span class="lineno">  216 </span><span class="spaces">                    </span><span class="istickedoff">| abs x /= x = [i|-#{ wordWidth }'sd#{ dataLiteral (-x) }|]</span>
<span class="lineno">  217 </span><span class="spaces">                    </span><span class="istickedoff">| <span class="tickonlytrue">otherwise</span> = [i|#{ wordWidth }'sd#{ dataLiteral x }|]</span>
<span class="lineno">  218 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  219 </span><span class="spaces">                </span><span class="istickedoff">disable =</span>
<span class="lineno">  220 </span><span class="spaces">                    </span><span class="istickedoff">[__i|</span>
<span class="lineno">  221 </span><span class="spaces">                        </span><span class="istickedoff">initial begin</span>
<span class="lineno">  222 </span><span class="spaces">                            </span><span class="istickedoff">@(negedge #{ sigRst });</span>
<span class="lineno">  223 </span><span class="spaces">                            </span><span class="istickedoff">#{ envInitFlagName } &lt;= 1;</span>
<span class="lineno">  224 </span><span class="spaces">                        </span><span class="istickedoff">end</span>
<span class="lineno">  225 </span><span class="spaces">                    </span><span class="istickedoff">|]</span>
<span class="lineno">  226 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  227 </span><span class="spaces">                </span><span class="istickedoff">envInitFlagName =</span>
<span class="lineno">  228 </span><span class="spaces">                    </span><span class="istickedoff">fromMaybe <span class="nottickedoff">(error &quot;SPI: testEnvironment: internal error&quot;)</span> $</span>
<span class="lineno">  229 </span><span class="spaces">                        </span><span class="istickedoff">testEnvironmentInitFlag tag <span class="nottickedoff">sio</span></span>
<span class="lineno">  230 </span><span class="spaces">             </span><span class="istickedoff">in case ioPorts of</span>
<span class="lineno">  231 </span><span class="spaces">                    </span><span class="istickedoff">SPISlave{..} -&gt;</span>
<span class="lineno">  232 </span><span class="spaces">                        </span><span class="istickedoff">let receiveCycle transmit =</span>
<span class="lineno">  233 </span><span class="spaces">                                </span><span class="istickedoff">let xs = map (\v -&gt; fromMaybe def $ transmit M.!? v) receivedVariablesSeq</span>
<span class="lineno">  234 </span><span class="spaces">                                 </span><span class="istickedoff">in [__i|</span>
<span class="lineno">  235 </span><span class="spaces">                                        </span><span class="istickedoff">$display( &quot;set data for sending #{ viaShow xs } by #{ tag }_io_test_input&quot; );</span>
<span class="lineno">  236 </span><span class="spaces">                                        </span><span class="istickedoff">#{ tag }_io_test_input = { #{ toVerilogLiteral xs } }; // #{ viaShow xs }</span>
<span class="lineno">  237 </span><span class="spaces">                                        </span><span class="istickedoff">#{ tag }_io_test_start_transaction = 1;                           @(posedge #{ sigClk });</span>
<span class="lineno">  238 </span><span class="spaces">                                        </span><span class="istickedoff">#{ tag }_io_test_start_transaction = 0;                           @(posedge #{ sigClk });</span>
<span class="lineno">  239 </span><span class="spaces">                                        </span><span class="istickedoff">repeat( #{ sendingDuration } ) @(posedge #{ sigClk });</span>
<span class="lineno">  240 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  241 </span><span class="spaces">                                    </span><span class="istickedoff">|]</span>
<span class="lineno">  242 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  243 </span><span class="spaces">                            </span><span class="istickedoff">sendingAssert transmit =</span>
<span class="lineno">  244 </span><span class="spaces">                                </span><span class="istickedoff">let xs = map (\v -&gt; fromMaybe <span class="nottickedoff">def</span> $ HM.lookup v transmit) sendedVariableSeq</span>
<span class="lineno">  245 </span><span class="spaces">                                 </span><span class="istickedoff">in [__i|</span>
<span class="lineno">  246 </span><span class="spaces">                                        </span><span class="istickedoff">@(posedge #{ tag }_io_test_start_transaction);</span>
<span class="lineno">  247 </span><span class="spaces">                                            </span><span class="istickedoff">$write( &quot;#{ tag }_io_test_output actual: %H except: %H ({ #{ toVerilogLiteral xs } })&quot;,</span>
<span class="lineno">  248 </span><span class="spaces">                                                </span><span class="istickedoff">#{ tag }_io_test_output, { #{ toVerilogLiteral xs } } );</span>
<span class="lineno">  249 </span><span class="spaces">                                            </span><span class="istickedoff">if ( #{ tag }_io_test_output != { #{ toVerilogLiteral xs } } ) $display(&quot;\t\tFAIL&quot;);</span>
<span class="lineno">  250 </span><span class="spaces">                                            </span><span class="istickedoff">else $display();</span>
<span class="lineno">  251 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  252 </span><span class="spaces">                                    </span><span class="istickedoff">|]</span>
<span class="lineno">  253 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  254 </span><span class="spaces">                            </span><span class="istickedoff">endDeviceInstance =</span>
<span class="lineno">  255 </span><span class="spaces">                                </span><span class="istickedoff">[__i|</span>
<span class="lineno">  256 </span><span class="spaces">                                    </span><span class="istickedoff">/*</span>
<span class="lineno">  257 </span><span class="spaces">                                    </span><span class="istickedoff">#{ pretty sio }</span>
<span class="lineno">  258 </span><span class="spaces">                                    </span><span class="istickedoff">*/</span>
<span class="lineno">  259 </span><span class="spaces">                                    </span><span class="istickedoff">reg #{ tag }_io_test_start_transaction;</span>
<span class="lineno">  260 </span><span class="spaces">                                    </span><span class="istickedoff">reg  [#{ frameWidth }-1:0] #{ tag }_io_test_input;</span>
<span class="lineno">  261 </span><span class="spaces">                                    </span><span class="istickedoff">wire #{ tag }_io_test_ready;</span>
<span class="lineno">  262 </span><span class="spaces">                                    </span><span class="istickedoff">wire [#{ frameWidth }-1:0] #{ tag }_io_test_output;</span>
<span class="lineno">  263 </span><span class="spaces">                                    </span><span class="istickedoff">initial #{ envInitFlagName } &lt;= 0; // should be defined on the testbench level.</span>
<span class="lineno">  264 </span><span class="spaces">                                    </span><span class="istickedoff">spi_master_driver \#</span>
<span class="lineno">  265 </span><span class="spaces">                                            </span><span class="istickedoff">( .DATA_WIDTH( #{ frameWidth } )</span>
<span class="lineno">  266 </span><span class="spaces">                                            </span><span class="istickedoff">, .SCLK_HALFPERIOD( 1 )</span>
<span class="lineno">  267 </span><span class="spaces">                                            </span><span class="istickedoff">) #{ tag }_io_test</span>
<span class="lineno">  268 </span><span class="spaces">                                        </span><span class="istickedoff">( .clk( #{ sigClk } )</span>
<span class="lineno">  269 </span><span class="spaces">                                        </span><span class="istickedoff">, .rst( #{ sigRst } )</span>
<span class="lineno">  270 </span><span class="spaces">                                        </span><span class="istickedoff">, .start_transaction( #{ tag }_io_test_start_transaction )</span>
<span class="lineno">  271 </span><span class="spaces">                                        </span><span class="istickedoff">, .data_in( #{ tag }_io_test_input )</span>
<span class="lineno">  272 </span><span class="spaces">                                        </span><span class="istickedoff">, .data_out( #{ tag }_io_test_output )</span>
<span class="lineno">  273 </span><span class="spaces">                                        </span><span class="istickedoff">, .ready( #{ tag }_io_test_ready )</span>
<span class="lineno">  274 </span><span class="spaces">                                        </span><span class="istickedoff">, .mosi( #{ slave_mosi } )</span>
<span class="lineno">  275 </span><span class="spaces">                                        </span><span class="istickedoff">, .miso( #{ slave_miso } )</span>
<span class="lineno">  276 </span><span class="spaces">                                        </span><span class="istickedoff">, .sclk( #{ slave_sclk } )</span>
<span class="lineno">  277 </span><span class="spaces">                                        </span><span class="istickedoff">, .cs( #{ slave_cs } )</span>
<span class="lineno">  278 </span><span class="spaces">                                        </span><span class="istickedoff">);</span>
<span class="lineno">  279 </span><span class="spaces">                                    </span><span class="istickedoff">initial #{ tag }_io_test.inner.shiftreg &lt;= 0;</span>
<span class="lineno">  280 </span><span class="spaces">                                </span><span class="istickedoff">|]</span>
<span class="lineno">  281 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  282 </span><span class="spaces">                            </span><span class="istickedoff">envDeviceControl =</span>
<span class="lineno">  283 </span><span class="spaces">                                </span><span class="istickedoff">[__i|</span>
<span class="lineno">  284 </span><span class="spaces">                                    </span><span class="istickedoff">initial begin</span>
<span class="lineno">  285 </span><span class="spaces">                                        </span><span class="istickedoff">#{ tag }_io_test_start_transaction &lt;= 0;</span>
<span class="lineno">  286 </span><span class="spaces">                                        </span><span class="istickedoff">#{ tag }_io_test_input &lt;= 0;</span>
<span class="lineno">  287 </span><span class="spaces">                                        </span><span class="istickedoff">@(negedge #{ sigRst });</span>
<span class="lineno">  288 </span><span class="spaces">                                        </span><span class="istickedoff">repeat(#{ timeLag }) @(posedge #{ sigClk });</span>
<span class="lineno">  289 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  290 </span><span class="spaces">                                        </span><span class="istickedoff">#{ nest 4 $ vsep $ map receiveCycle receivedVarsValues }</span>
<span class="lineno">  291 </span><span class="spaces">                                        </span><span class="istickedoff">repeat ( 5 ) begin</span>
<span class="lineno">  292 </span><span class="spaces">                                            </span><span class="istickedoff">#{ nest 8 $ receiveCycle def }</span>
<span class="lineno">  293 </span><span class="spaces">                                        </span><span class="istickedoff">end</span>
<span class="lineno">  294 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  295 </span><span class="spaces">                                        </span><span class="istickedoff">// $finish; // DON'T DO THAT (with this line test can pass without data checking)</span>
<span class="lineno">  296 </span><span class="spaces">                                    </span><span class="istickedoff">end</span>
<span class="lineno">  297 </span><span class="spaces">                                </span><span class="istickedoff">|]</span>
<span class="lineno">  298 </span><span class="spaces">                            </span><span class="istickedoff">envDeviceCheck =</span>
<span class="lineno">  299 </span><span class="spaces">                                </span><span class="istickedoff">[__i|</span>
<span class="lineno">  300 </span><span class="spaces">                                    </span><span class="istickedoff">initial begin</span>
<span class="lineno">  301 </span><span class="spaces">                                        </span><span class="istickedoff">@(negedge #{ sigRst });</span>
<span class="lineno">  302 </span><span class="spaces">                                        </span><span class="istickedoff">repeat ( OUTPUT_LATENCY ) @(posedge #{ tag }_io_test_start_transaction); // latency</span>
<span class="lineno">  303 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  304 </span><span class="spaces">                                        </span><span class="istickedoff">#{ nest 4 $ vsep $ map sendingAssert sendedVarsValues }</span>
<span class="lineno">  305 </span><span class="spaces">                                        </span><span class="istickedoff">forever begin</span>
<span class="lineno">  306 </span><span class="spaces">                                            </span><span class="istickedoff">@(posedge spi_io_test_start_transaction);</span>
<span class="lineno">  307 </span><span class="spaces">                                            </span><span class="istickedoff">$display( &quot;#{ tag }_io_test_output actual: %H&quot;, #{ tag }_io_test_output );</span>
<span class="lineno">  308 </span><span class="spaces">                                        </span><span class="istickedoff">end</span>
<span class="lineno">  309 </span><span class="spaces">                                    </span><span class="istickedoff">end</span>
<span class="lineno">  310 </span><span class="spaces">                                </span><span class="istickedoff">|]</span>
<span class="lineno">  311 </span><span class="spaces">                         </span><span class="istickedoff">in -- FIXME: do not check output signals when we drop data</span>
<span class="lineno">  312 </span><span class="spaces">                            </span><span class="istickedoff">Just</span>
<span class="lineno">  313 </span><span class="spaces">                                </span><span class="istickedoff">[__i|</span>
<span class="lineno">  314 </span><span class="spaces">                                    </span><span class="istickedoff">////////////////////////////////////////</span>
<span class="lineno">  315 </span><span class="spaces">                                    </span><span class="istickedoff">// SPI test environment</span>
<span class="lineno">  316 </span><span class="spaces">                                    </span><span class="istickedoff">localparam NITTA_LATENCY = 1;</span>
<span class="lineno">  317 </span><span class="spaces">                                    </span><span class="istickedoff">localparam OUTPUT_LATENCY = 3;</span>
<span class="lineno">  318 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  319 </span><span class="spaces">                                    </span><span class="istickedoff">// SPI device in test environment</span>
<span class="lineno">  320 </span><span class="spaces">                                    </span><span class="istickedoff">#{ endDeviceInstance :: Verilog }</span>
<span class="lineno">  321 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  322 </span><span class="spaces">                                    </span><span class="istickedoff">// SPI device in test environment control</span>
<span class="lineno">  323 </span><span class="spaces">                                    </span><span class="istickedoff">#{ if frameWordCount == 0 then disable else envDeviceControl }</span>
<span class="lineno">  324 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  325 </span><span class="spaces">                                    </span><span class="istickedoff">// SPI device in test environment check</span>
<span class="lineno">  326 </span><span class="spaces">                                    </span><span class="istickedoff">#{ if frameWordCount == 0 then disable else envDeviceCheck }</span>
<span class="lineno">  327 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  328 </span><span class="spaces">                                    </span><span class="istickedoff">// SPI environment initialization flag set</span>
<span class="lineno">  329 </span><span class="spaces">                                    </span><span class="istickedoff">initial begin</span>
<span class="lineno">  330 </span><span class="spaces">                                        </span><span class="istickedoff">repeat ( NITTA_LATENCY ) @(posedge spi_io_test_start_transaction);</span>
<span class="lineno">  331 </span><span class="spaces">                                        </span><span class="istickedoff">spi_env_init_flag &lt;= 1;</span>
<span class="lineno">  332 </span><span class="spaces">                                    </span><span class="istickedoff">end</span>
<span class="lineno">  333 </span><span class="spaces">                                </span><span class="istickedoff">|]</span>
<span class="lineno">  334 </span><span class="spaces">                    </span><span class="istickedoff">SPIMaster{..} -&gt;</span>
<span class="lineno">  335 </span><span class="spaces">                        </span><span class="istickedoff">let receiveCycle transmit =</span>
<span class="lineno">  336 </span><span class="spaces">                                </span><span class="istickedoff">let xs = map (\v -&gt; fromMaybe def $ transmit M.!? v) receivedVariablesSeq</span>
<span class="lineno">  337 </span><span class="spaces">                                 </span><span class="istickedoff">in [__i|</span>
<span class="lineno">  338 </span><span class="spaces">                                        </span><span class="istickedoff">#{ tag }_io_test_input = { #{ toVerilogLiteral xs } }; // #{ xs }</span>
<span class="lineno">  339 </span><span class="spaces">                                        </span><span class="istickedoff">@(posedge #{ tag }_io_test_ready);</span>
<span class="lineno">  340 </span><span class="spaces">                                    </span><span class="istickedoff">|]</span>
<span class="lineno">  341 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  342 </span><span class="spaces">                            </span><span class="istickedoff">sendingAssert transmit =</span>
<span class="lineno">  343 </span><span class="spaces">                                </span><span class="istickedoff">let xs = map (\v -&gt; fromMaybe <span class="nottickedoff">def</span> $ HM.lookup v transmit) sendedVariableSeq</span>
<span class="lineno">  344 </span><span class="spaces">                                 </span><span class="istickedoff">in [__i|</span>
<span class="lineno">  345 </span><span class="spaces">                                        </span><span class="istickedoff">@(posedge #{ tag }_io_test_ready);</span>
<span class="lineno">  346 </span><span class="spaces">                                            </span><span class="istickedoff">$display( &quot;#{ tag }_io_test_output except: %H ({ #{ toVerilogLiteral xs } })&quot;, { #{ toVerilogLiteral xs } } );</span>
<span class="lineno">  347 </span><span class="spaces">                                            </span><span class="istickedoff">$display( &quot;#{ tag }_io_test_output actual: %H&quot;, #{ tag }_io_test_output );</span>
<span class="lineno">  348 </span><span class="spaces">                                            </span><span class="istickedoff">if ( #{ tag }_io_test_output !=  { #{ toVerilogLiteral xs } } )</span>
<span class="lineno">  349 </span><span class="spaces">                                                </span><span class="istickedoff">$display(&quot;                       FAIL&quot;);</span>
<span class="lineno">  350 </span><span class="spaces">                                            </span><span class="istickedoff">$display();</span>
<span class="lineno">  351 </span><span class="spaces">                                    </span><span class="istickedoff">|]</span>
<span class="lineno">  352 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  353 </span><span class="spaces">                            </span><span class="istickedoff">envInstance =</span>
<span class="lineno">  354 </span><span class="spaces">                                </span><span class="istickedoff">[__i|</span>
<span class="lineno">  355 </span><span class="spaces">                                    </span><span class="istickedoff">/*</span>
<span class="lineno">  356 </span><span class="spaces">                                    </span><span class="istickedoff">#{ pretty sio }</span>
<span class="lineno">  357 </span><span class="spaces">                                    </span><span class="istickedoff">*/</span>
<span class="lineno">  358 </span><span class="spaces">                                    </span><span class="istickedoff">reg #{ tag }_io_test_start_transaction;</span>
<span class="lineno">  359 </span><span class="spaces">                                    </span><span class="istickedoff">reg  [#{ frameWidth }-1:0] #{ tag }_io_test_input;</span>
<span class="lineno">  360 </span><span class="spaces">                                    </span><span class="istickedoff">wire #{ tag }_io_test_ready;</span>
<span class="lineno">  361 </span><span class="spaces">                                    </span><span class="istickedoff">wire [#{ frameWidth }-1:0] #{ tag }_io_test_output;</span>
<span class="lineno">  362 </span><span class="spaces">                                    </span><span class="istickedoff">initial #{ envInitFlagName } &lt;= 0; // should be defined on the testbench level.</span>
<span class="lineno">  363 </span><span class="spaces">                                    </span><span class="istickedoff">spi_slave_driver \#</span>
<span class="lineno">  364 </span><span class="spaces">                                            </span><span class="istickedoff">( .DATA_WIDTH( #{ frameWidth } )</span>
<span class="lineno">  365 </span><span class="spaces">                                            </span><span class="istickedoff">) #{ tag }_io_test_slave</span>
<span class="lineno">  366 </span><span class="spaces">                                        </span><span class="istickedoff">( .clk( #{ sigClk } )</span>
<span class="lineno">  367 </span><span class="spaces">                                        </span><span class="istickedoff">, .rst( #{ sigRst } )</span>
<span class="lineno">  368 </span><span class="spaces">                                        </span><span class="istickedoff">, .data_in( #{ tag }_io_test_input )</span>
<span class="lineno">  369 </span><span class="spaces">                                        </span><span class="istickedoff">, .data_out( #{ tag }_io_test_output )</span>
<span class="lineno">  370 </span><span class="spaces">                                        </span><span class="istickedoff">, .ready( #{ tag }_io_test_ready )</span>
<span class="lineno">  371 </span><span class="spaces">                                        </span><span class="istickedoff">, .mosi( #{ master_mosi } )</span>
<span class="lineno">  372 </span><span class="spaces">                                        </span><span class="istickedoff">, .miso( #{ master_miso } )</span>
<span class="lineno">  373 </span><span class="spaces">                                        </span><span class="istickedoff">, .sclk( #{ master_sclk } )</span>
<span class="lineno">  374 </span><span class="spaces">                                        </span><span class="istickedoff">, .cs( #{ master_cs } )</span>
<span class="lineno">  375 </span><span class="spaces">                                        </span><span class="istickedoff">);</span>
<span class="lineno">  376 </span><span class="spaces">                                </span><span class="istickedoff">|]</span>
<span class="lineno">  377 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  378 </span><span class="spaces">                            </span><span class="istickedoff">interactions =</span>
<span class="lineno">  379 </span><span class="spaces">                                </span><span class="istickedoff">[__i|</span>
<span class="lineno">  380 </span><span class="spaces">                                    </span><span class="istickedoff">// SPI Input signal generation</span>
<span class="lineno">  381 </span><span class="spaces">                                    </span><span class="istickedoff">initial begin</span>
<span class="lineno">  382 </span><span class="spaces">                                        </span><span class="istickedoff">@(negedge #{ sigRst });</span>
<span class="lineno">  383 </span><span class="spaces">                                        </span><span class="istickedoff">#{ nest 4 $ receiveCycle $ head receivedVarsValues }</span>
<span class="lineno">  384 </span><span class="spaces">                                        </span><span class="istickedoff">#{ envInitFlagName } &lt;= 1;</span>
<span class="lineno">  385 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  386 </span><span class="spaces">                                        </span><span class="istickedoff">#{ nest 4 $ vsep $ map receiveCycle $ tail receivedVarsValues }</span>
<span class="lineno">  387 </span><span class="spaces">                                        </span><span class="istickedoff">repeat(70) @(posedge #{ sigClk });</span>
<span class="lineno">  388 </span><span class="spaces">                                        </span><span class="istickedoff">// $finish; // DON'T DO THAT (with this line test can pass without data checking)</span>
<span class="lineno">  389 </span><span class="spaces">                                    </span><span class="istickedoff">end</span>
<span class="lineno">  390 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">  391 </span><span class="spaces">                                    </span><span class="istickedoff">// SPI Output signal checking</span>
<span class="lineno">  392 </span><span class="spaces">                                    </span><span class="istickedoff">initial begin</span>
<span class="lineno">  393 </span><span class="spaces">                                        </span><span class="istickedoff">@(negedge #{ sigRst });</span>
<span class="lineno">  394 </span><span class="spaces">                                        </span><span class="istickedoff">repeat(2) @(posedge #{ tag }_io_test_ready);</span>
<span class="lineno">  395 </span><span class="spaces">                                        </span><span class="istickedoff">#{ nest 4 $ vsep $ map sendingAssert sendedVarsValues }</span>
<span class="lineno">  396 </span><span class="spaces">                                    </span><span class="istickedoff">end</span>
<span class="lineno">  397 </span><span class="spaces">                                </span><span class="istickedoff">|]</span>
<span class="lineno">  398 </span><span class="spaces">                         </span><span class="istickedoff">in Just (envInstance &lt;&gt; line &lt;&gt; line &lt;&gt; if <span class="tickonlyfalse">frameWordCount == 0</span> then <span class="nottickedoff">disable</span> else interactions)</span>
<span class="lineno">  399 </span><span class="spaces">    </span><span class="istickedoff">testEnvironment _title _pu _env _tEnv = <span class="nottickedoff">error &quot;internal error&quot;</span></span></span>

</pre>
</body>
</html>
