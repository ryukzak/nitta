<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="decl"><span class="nottickedoff">never executed</span> <span class="tickonlytrue">always true</span> <span class="tickonlyfalse">always false</span></span>
</pre>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE FlexibleContexts #-}
<span class="lineno">    2 </span>{-# LANGUAGE ImportQualifiedPost #-}
<span class="lineno">    3 </span>{-# LANGUAGE LambdaCase #-}
<span class="lineno">    4 </span>{-# LANGUAGE NamedFieldPuns #-}
<span class="lineno">    5 </span>{-# LANGUAGE OverloadedStrings #-}
<span class="lineno">    6 </span>{-# OPTIONS_GHC -Wno-type-defaults -Wno-incomplete-uni-patterns #-}
<span class="lineno">    7 </span>
<span class="lineno">    8 </span>{- |
<span class="lineno">    9 </span>Module      : NITTA.Frontends.Lua
<span class="lineno">   10 </span>Description : Lua frontend prototype
<span class="lineno">   11 </span>Copyright   : (c) Aleksandr Penskoi, 2019
<span class="lineno">   12 </span>License     : BSD3
<span class="lineno">   13 </span>Maintainer  : aleksandr.penskoi@gmail.com
<span class="lineno">   14 </span>Stability   : experimental
<span class="lineno">   15 </span>
<span class="lineno">   16 </span>This module analyzes an abstract syntax tree of the Lua language source code, provided by Language.Lua module,
<span class="lineno">   17 </span>and stores it into a NITTA's data flow graph.
<span class="lineno">   18 </span>
<span class="lineno">   19 </span>Supported Lua costructions are:
<span class="lineno">   20 </span>
<span class="lineno">   21 </span>- Simple math operators (addition, subtraction, multiplication and division);
<span class="lineno">   22 </span>- Variable assignments;
<span class="lineno">   23 </span>- Bitwise left and right shifts;
<span class="lineno">   24 </span>- Recursive calls.
<span class="lineno">   25 </span>
<span class="lineno">   26 </span>The naming of variables in the output dataflow graph:
<span class="lineno">   27 </span>
<span class="lineno">   28 </span>@
<span class="lineno">   29 </span>    x^1#2 -- for variables
<span class="lineno">   30 </span>    | | |
<span class="lineno">   31 </span>    | | +-- value access number (one for each), e.g.
<span class="lineno">   32 </span>    | |     x = 1; send(x); reg(x) -- two accesses
<span class="lineno">   33 </span>    | |
<span class="lineno">   34 </span>    | +---- value assignment number (one for each, optional)
<span class="lineno">   35 </span>    |       x = f(1); x = g(2) -- two assignments
<span class="lineno">   36 </span>    |
<span class="lineno">   37 </span>    +------ original variable name
<span class="lineno">   38 </span>
<span class="lineno">   39 </span>    !123#3 -- for constant
<span class="lineno">   40 </span>      |  |
<span class="lineno">   41 </span>      |  +--- value access number
<span class="lineno">   42 </span>      |
<span class="lineno">   43 </span>      +------ value: 123
<span class="lineno">   44 </span>
<span class="lineno">   45 </span>    _a#4 -- for an unnamed variable (example see below)
<span class="lineno">   46 </span>     | |
<span class="lineno">   47 </span>     | +--- value access number
<span class="lineno">   48 </span>     |
<span class="lineno">   49 </span>     +----- char of unnamed variable (a, b..., aa, ab, ...)
<span class="lineno">   50 </span>@
<span class="lineno">   51 </span>
<span class="lineno">   52 </span>Example:
<span class="lineno">   53 </span>
<span class="lineno">   54 </span>&gt;&gt;&gt; :{
<span class="lineno">   55 </span>void $ mapM print $ functions (frDataFlow $ translateLua $ T.pack $ unlines
<span class="lineno">   56 </span>    [ &quot;function f()&quot;
<span class="lineno">   57 </span>    , &quot;    local a = 1 + 2 + 3&quot;
<span class="lineno">   58 </span>    , &quot;    local b = a + 4 + 5&quot;
<span class="lineno">   59 </span>    , &quot;    b = b * 1 + 2&quot;
<span class="lineno">   60 </span>    , &quot;    c, d = b / 2&quot;
<span class="lineno">   61 </span>    , &quot;    send(b)&quot;
<span class="lineno">   62 </span>    , &quot;end&quot;
<span class="lineno">   63 </span>    , &quot;f()&quot;
<span class="lineno">   64 </span>    ] :: DataFlowGraph String Int)
<span class="lineno">   65 </span>:}
<span class="lineno">   66 </span>const(1) = !1#0 = !1#1
<span class="lineno">   67 </span>const(2) = !2#0 = !2#1 = !2#2
<span class="lineno">   68 </span>!1#0 + !2#0 = _0#a
<span class="lineno">   69 </span>const(3) = !3#0
<span class="lineno">   70 </span>_0#a + !3#0 = a^0#0
<span class="lineno">   71 </span>const(4) = !4#0
<span class="lineno">   72 </span>a^0#0 + !4#0 = _0#b
<span class="lineno">   73 </span>const(5) = !5#0
<span class="lineno">   74 </span>_0#b + !5#0 = b^0#0
<span class="lineno">   75 </span>b^0#0 * !1#1 = _1#b
<span class="lineno">   76 </span>_1#b + !2#1 = b^1#0 = b^1#1
<span class="lineno">   77 </span>!2#2 / b^1#0 = _; !2#2 mod b^1#0 = _
<span class="lineno">   78 </span>send(b^1#1)
<span class="lineno">   79 </span>-}
<span class="lineno">   80 </span>module NITTA.Frontends.Lua (
<span class="lineno">   81 </span>    translateLua,
<span class="lineno">   82 </span>    FrontendResult (..),
<span class="lineno">   83 </span>    TraceVar (..),
<span class="lineno">   84 </span>
<span class="lineno">   85 </span>    -- * Internal
<span class="lineno">   86 </span>    LuaAlgBuilder (..),
<span class="lineno">   87 </span>    LuaStatement (..),
<span class="lineno">   88 </span>    LuaValueInstance (..),
<span class="lineno">   89 </span>    buildAlg,
<span class="lineno">   90 </span>    findStartupFunction,
<span class="lineno">   91 </span>    getLuaBlockFromSources,
<span class="lineno">   92 </span>    processStatement,
<span class="lineno">   93 </span>) where
<span class="lineno">   94 </span>
<span class="lineno">   95 </span>import Control.Monad.State
<span class="lineno">   96 </span>import Data.HashMap.Strict qualified as HM
<span class="lineno">   97 </span>import Data.Hashable
<span class="lineno">   98 </span>import Data.Maybe
<span class="lineno">   99 </span>import Data.String
<span class="lineno">  100 </span>import Data.String.ToString
<span class="lineno">  101 </span>import Data.Text qualified as T
<span class="lineno">  102 </span>import Language.Lua hiding (Var)
<span class="lineno">  103 </span>import NITTA.Frontends.Common
<span class="lineno">  104 </span>import NITTA.Intermediate.DataFlow
<span class="lineno">  105 </span>import NITTA.Intermediate.Functions qualified as F
<span class="lineno">  106 </span>import NITTA.Intermediate.Types
<span class="lineno">  107 </span>import NITTA.Utils.Base
<span class="lineno">  108 </span>import Prelude hiding (EQ, GT, LT)
<span class="lineno">  109 </span>
<span class="lineno">  110 </span><span class="decl"><span class="istickedoff">getUniqueLuaVariableName LuaValueInstance{lviName, lviIsConstant = True} luaValueAccessCount = &quot;!&quot; &lt;&gt; lviName &lt;&gt; &quot;#&quot; &lt;&gt; showText luaValueAccessCount</span>
<span class="lineno">  111 </span><span class="spaces"></span><span class="istickedoff">getUniqueLuaVariableName LuaValueInstance{lviName, lviAssignCount} luaValueAccessCount</span>
<span class="lineno">  112 </span><span class="spaces">    </span><span class="istickedoff">| T.head lviName == '_' = lviName</span>
<span class="lineno">  113 </span><span class="spaces">    </span><span class="istickedoff">| <span class="tickonlytrue">otherwise</span> = lviName &lt;&gt; &quot;^&quot; &lt;&gt; showText lviAssignCount &lt;&gt; &quot;#&quot; &lt;&gt; showText luaValueAccessCount</span></span>
<span class="lineno">  114 </span>
<span class="lineno">  115 </span>data LuaStatement x = LuaStatement
<span class="lineno">  116 </span>    { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">fIn</span></span></span> :: [T.Text]
<span class="lineno">  117 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">fOut</span></span></span> :: [LuaValueInstance]
<span class="lineno">  118 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">fName</span></span></span> :: T.Text
<span class="lineno">  119 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">fValues</span></span></span> :: [x]
<span class="lineno">  120 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">fInt</span></span></span> :: [Int]
<span class="lineno">  121 </span>    }
<span class="lineno">  122 </span>    deriving (<span class="decl"><span class="nottickedoff">Show</span></span>, <span class="decl"><span class="istickedoff">Eq</span></span>)
<span class="lineno">  123 </span>
<span class="lineno">  124 </span>-- | Stores information about a particular version of a variable. The version of a variable changes after assigning a new value to it.
<span class="lineno">  125 </span>data LuaValueInstance = LuaValueInstance
<span class="lineno">  126 </span>    { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">lviName</span></span></span> :: T.Text
<span class="lineno">  127 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">lviAssignCount</span></span></span> :: Int
<span class="lineno">  128 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">lviIsConstant</span></span></span> :: Bool
<span class="lineno">  129 </span>    }
<span class="lineno">  130 </span>    deriving (<span class="decl"><span class="nottickedoff">Show</span></span>, <span class="decl"><span class="istickedoff">Eq</span></span>)
<span class="lineno">  131 </span>
<span class="lineno">  132 </span>instance Hashable LuaValueInstance where
<span class="lineno">  133 </span>    <span class="decl"><span class="istickedoff">hashWithSalt i LuaValueInstance{lviName, lviAssignCount, lviIsConstant} =</span>
<span class="lineno">  134 </span><span class="spaces">        </span><span class="istickedoff">( (hashWithSalt i lviName * 31)</span>
<span class="lineno">  135 </span><span class="spaces">            </span><span class="istickedoff">+ hashWithSalt i lviAssignCount</span>
<span class="lineno">  136 </span><span class="spaces">        </span><span class="istickedoff">)</span>
<span class="lineno">  137 </span><span class="spaces">            </span><span class="istickedoff">* 31</span>
<span class="lineno">  138 </span><span class="spaces">            </span><span class="istickedoff">+ hashWithSalt i lviIsConstant</span></span>
<span class="lineno">  139 </span>
<span class="lineno">  140 </span>data LuaAlgBuilder x = LuaAlgBuilder
<span class="lineno">  141 </span>    { <span class="nottickedoff"><span class="decl"><span class="nottickedoff">algGraph</span></span></span> :: [LuaStatement x]
<span class="lineno">  142 </span>    -- ^ A list containing all expressions to be added to the final graph.
<span class="lineno">  143 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">algLatestLuaValueInstance</span></span></span> :: HM.HashMap T.Text LuaValueInstance
<span class="lineno">  144 </span>    -- ^ A table that maps a variable name to the most recent corresponding LuaValueInstance.
<span class="lineno">  145 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">algVarCounters</span></span></span> :: HM.HashMap T.Text Int
<span class="lineno">  146 </span>    -- ^ A table needed to generate unique temporary variable names.
<span class="lineno">  147 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">algVars</span></span></span> :: HM.HashMap LuaValueInstance [T.Text]
<span class="lineno">  148 </span>    -- ^ A table lists all uses of a particular LuaValueInstance.
<span class="lineno">  149 </span>    , <span class="istickedoff"><span class="decl"><span class="istickedoff">algStartupArgs</span></span></span> :: HM.HashMap Int (T.Text, T.Text)
<span class="lineno">  150 </span>    -- ^ Map argument index to the variable name and initial value (in text).
<span class="lineno">  151 </span>    , <span class="nottickedoff"><span class="decl"><span class="nottickedoff">algConstants</span></span></span> :: HM.HashMap T.Text LuaValueInstance
<span class="lineno">  152 </span>    -- ^ A table correlating constant with LuaValueInstance which store this constant.
<span class="lineno">  153 </span>    , <span class="istickedoff"><span class="decl"><span class="istickedoff">algTraceFuncs</span></span></span> :: [([T.Text], Maybe T.Text)]
<span class="lineno">  154 </span>    -- ^ A list that stores debug information about monitored variables and their display formats.
<span class="lineno">  155 </span>    }
<span class="lineno">  156 </span>    deriving (<span class="decl"><span class="nottickedoff">Show</span></span>)
<span class="lineno">  157 </span>
<span class="lineno">  158 </span>-- left part of lua statement
<span class="lineno">  159 </span><span class="decl"><span class="istickedoff">parseLeftExp (VarName (Name v)) = v</span>
<span class="lineno">  160 </span><span class="spaces"></span><span class="istickedoff">parseLeftExp var = <span class="nottickedoff">error $ &quot;unexpected lua variable declaration format : &quot; &lt;&gt; show var</span></span></span>
<span class="lineno">  161 </span>
<span class="lineno">  162 </span>-- right part of lua statement
<span class="lineno">  163 </span><span class="decl"><span class="istickedoff">parseRightExp [fOut] (Binop ShiftL a (Number IntNum s)) = do</span>
<span class="lineno">  164 </span><span class="spaces">    </span><span class="istickedoff">varName &lt;- parseExpArg <span class="nottickedoff">fOut</span> a</span>
<span class="lineno">  165 </span><span class="spaces">    </span><span class="istickedoff">addVariable [varName] [fOut] [] &quot;shiftL&quot; [readText s]</span>
<span class="lineno">  166 </span><span class="spaces"></span><span class="istickedoff">parseRightExp [fOut] (Binop ShiftR a (Number IntNum s)) = do</span>
<span class="lineno">  167 </span><span class="spaces">    </span><span class="istickedoff">varName &lt;- parseExpArg <span class="nottickedoff">fOut</span> a</span>
<span class="lineno">  168 </span><span class="spaces">    </span><span class="istickedoff">addVariable [varName] [fOut] [] &quot;shiftR&quot; [readText s]</span>
<span class="lineno">  169 </span><span class="spaces"></span><span class="istickedoff">parseRightExp [fOut] (Number _ valueString) = do</span>
<span class="lineno">  170 </span><span class="spaces">    </span><span class="istickedoff">addVariable [] [fOut] [readText valueString] &quot;constant&quot; []</span>
<span class="lineno">  171 </span><span class="spaces"></span><span class="istickedoff">parseRightExp fOut@(x : _) (Binop op a b) = do</span>
<span class="lineno">  172 </span><span class="spaces">    </span><span class="istickedoff">varNameA &lt;- parseExpArg x a</span>
<span class="lineno">  173 </span><span class="spaces">    </span><span class="istickedoff">varNameB &lt;- parseExpArg x b</span>
<span class="lineno">  174 </span><span class="spaces">    </span><span class="istickedoff">addVariable [varNameA, varNameB] fOut [] (getBinopFuncName op) []</span>
<span class="lineno">  175 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  176 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName Add = &quot;add&quot;</span>
<span class="lineno">  177 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName Sub = &quot;sub&quot;</span>
<span class="lineno">  178 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName Mul = &quot;multiply&quot;</span>
<span class="lineno">  179 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName Div = &quot;divide&quot;</span>
<span class="lineno">  180 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName LT = <span class="nottickedoff">&quot;lessThan&quot;</span></span>
<span class="lineno">  181 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName LTE = <span class="nottickedoff">&quot;lessThanOrEqual&quot;</span></span>
<span class="lineno">  182 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName EQ = <span class="nottickedoff">&quot;equal&quot;</span></span>
<span class="lineno">  183 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName GTE = <span class="nottickedoff">&quot;greaterThanOrEqual&quot;</span></span>
<span class="lineno">  184 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName GT = <span class="nottickedoff">&quot;greaterThan&quot;</span></span>
<span class="lineno">  185 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName And = &quot;and&quot;</span>
<span class="lineno">  186 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName Or = &quot;or&quot;</span>
<span class="lineno">  187 </span><span class="spaces">        </span><span class="istickedoff">getBinopFuncName o = <span class="nottickedoff">error $ &quot;unknown binop: &quot; &lt;&gt; show o</span></span>
<span class="lineno">  188 </span><span class="spaces"></span><span class="istickedoff">parseRightExp fOut (PrefixExp (Paren e)) = parseRightExp fOut e</span>
<span class="lineno">  189 </span><span class="spaces"></span><span class="istickedoff">parseRightExp fOut (Unop Neg (Number numType name)) = parseRightExp fOut (Number <span class="nottickedoff">numType</span> (&quot;-&quot; &lt;&gt; name))</span>
<span class="lineno">  190 </span><span class="spaces"></span><span class="istickedoff">parseRightExp [fOut] (Unop Neg expr@(PrefixExp _)) = do</span>
<span class="lineno">  191 </span><span class="spaces">    </span><span class="istickedoff">varName &lt;- parseExpArg <span class="nottickedoff">fOut</span> expr</span>
<span class="lineno">  192 </span><span class="spaces">    </span><span class="istickedoff">addVariable [varName] [fOut] [] &quot;neg&quot; []</span>
<span class="lineno">  193 </span><span class="spaces"></span><span class="istickedoff">parseRightExp fOut (Unop Not (Number numType name)) = <span class="nottickedoff">parseRightExp fOut (Number numType (&quot;not&quot; &lt;&gt; name))</span></span>
<span class="lineno">  194 </span><span class="spaces"></span><span class="istickedoff">parseRightExp [fOut] (Unop Not expr@(PrefixExp _)) = <span class="nottickedoff">do</span></span>
<span class="lineno">  195 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">varName &lt;- parseExpArg fOut expr</span></span>
<span class="lineno">  196 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">addVariable [varName] [fOut] [] &quot;not&quot; []</span></span>
<span class="lineno">  197 </span><span class="spaces"></span><span class="istickedoff">parseRightExp</span>
<span class="lineno">  198 </span><span class="spaces">    </span><span class="istickedoff">[fOut]</span>
<span class="lineno">  199 </span><span class="spaces">    </span><span class="istickedoff">( PrefixExp</span>
<span class="lineno">  200 </span><span class="spaces">            </span><span class="istickedoff">( PEFunCall</span>
<span class="lineno">  201 </span><span class="spaces">                    </span><span class="istickedoff">( NormalFunCall</span>
<span class="lineno">  202 </span><span class="spaces">                            </span><span class="istickedoff">(PEVar (VarName (Name fname)))</span>
<span class="lineno">  203 </span><span class="spaces">                            </span><span class="istickedoff">(Args args)</span>
<span class="lineno">  204 </span><span class="spaces">                        </span><span class="istickedoff">)</span>
<span class="lineno">  205 </span><span class="spaces">                </span><span class="istickedoff">)</span>
<span class="lineno">  206 </span><span class="spaces">        </span><span class="istickedoff">) = do</span>
<span class="lineno">  207 </span><span class="spaces">        </span><span class="istickedoff">fIn &lt;- mapM (parseExpArg fOut) args</span>
<span class="lineno">  208 </span><span class="spaces">        </span><span class="istickedoff">addFunction fname fIn [fOut]</span>
<span class="lineno">  209 </span><span class="spaces"></span><span class="istickedoff">parseRightExp [fOut] (PrefixExp (PEVar (VarName (Name name)))) = do</span>
<span class="lineno">  210 </span><span class="spaces">    </span><span class="istickedoff">addAlias fOut name</span>
<span class="lineno">  211 </span><span class="spaces"></span><span class="istickedoff">parseRightExp _ expr = <span class="nottickedoff">error $ &quot;unknown expression : &quot; &lt;&gt; show expr</span></span></span>
<span class="lineno">  212 </span>
<span class="lineno">  213 </span><span class="decl"><span class="istickedoff">parseExpArg _ n@(Number _ _) = do</span>
<span class="lineno">  214 </span><span class="spaces">    </span><span class="istickedoff">addConstant n</span>
<span class="lineno">  215 </span><span class="spaces"></span><span class="istickedoff">parseExpArg fOut expr@(Unop Neg _) = do</span>
<span class="lineno">  216 </span><span class="spaces">    </span><span class="istickedoff">name &lt;- getNextTmpVarName fOut</span>
<span class="lineno">  217 </span><span class="spaces">    </span><span class="istickedoff">_ &lt;- parseRightExp [name] expr</span>
<span class="lineno">  218 </span><span class="spaces">    </span><span class="istickedoff">addVariableAccess name</span>
<span class="lineno">  219 </span><span class="spaces"></span><span class="istickedoff">parseExpArg _ (PrefixExp (PEVar (VarName (Name name)))) = do</span>
<span class="lineno">  220 </span><span class="spaces">    </span><span class="istickedoff">addVariableAccess name</span>
<span class="lineno">  221 </span><span class="spaces"></span><span class="istickedoff">parseExpArg fOut binop@Binop{} = do</span>
<span class="lineno">  222 </span><span class="spaces">    </span><span class="istickedoff">name &lt;- getNextTmpVarName fOut</span>
<span class="lineno">  223 </span><span class="spaces">    </span><span class="istickedoff">_ &lt;- parseRightExp [name] binop</span>
<span class="lineno">  224 </span><span class="spaces">    </span><span class="istickedoff">addVariableAccess name</span>
<span class="lineno">  225 </span><span class="spaces"></span><span class="istickedoff">parseExpArg fOut (PrefixExp (Paren arg)) = parseExpArg fOut arg</span>
<span class="lineno">  226 </span><span class="spaces"></span><span class="istickedoff">parseExpArg fOut call@(PrefixExp (PEFunCall _)) = do</span>
<span class="lineno">  227 </span><span class="spaces">    </span><span class="istickedoff">name &lt;- getNextTmpVarName fOut</span>
<span class="lineno">  228 </span><span class="spaces">    </span><span class="istickedoff">_ &lt;- parseRightExp [name] call</span>
<span class="lineno">  229 </span><span class="spaces">    </span><span class="istickedoff">addVariableAccess name</span>
<span class="lineno">  230 </span><span class="spaces"></span><span class="istickedoff">parseExpArg _ _ = <span class="nottickedoff">undefined</span></span></span>
<span class="lineno">  231 </span>
<span class="lineno">  232 </span><span class="decl"><span class="istickedoff">getNextTmpVarName fOut</span>
<span class="lineno">  233 </span><span class="spaces">    </span><span class="istickedoff">| T.isInfixOf &quot;#&quot; fOut = getNextTmpVarName (T.splitOn &quot;#&quot; fOut !! 1)</span>
<span class="lineno">  234 </span><span class="spaces">    </span><span class="istickedoff">| <span class="tickonlytrue">otherwise</span> = do</span>
<span class="lineno">  235 </span><span class="spaces">        </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algVarCounters} &lt;- get</span>
<span class="lineno">  236 </span><span class="spaces">        </span><span class="istickedoff">case HM.lookup fOut algVarCounters of</span>
<span class="lineno">  237 </span><span class="spaces">            </span><span class="istickedoff">Just value -&gt; do</span>
<span class="lineno">  238 </span><span class="spaces">                </span><span class="istickedoff">put luaAlgBuilder{algVarCounters = HM.insert fOut (value + 1) algVarCounters}</span>
<span class="lineno">  239 </span><span class="spaces">                </span><span class="istickedoff">return $ &quot;_&quot; &lt;&gt; showText value &lt;&gt; &quot;#&quot; &lt;&gt; fOut</span>
<span class="lineno">  240 </span><span class="spaces">            </span><span class="istickedoff">Nothing -&gt; do</span>
<span class="lineno">  241 </span><span class="spaces">                </span><span class="istickedoff">put luaAlgBuilder{algVarCounters = HM.insert fOut 1 algVarCounters}</span>
<span class="lineno">  242 </span><span class="spaces">                </span><span class="istickedoff">return $ &quot;_0#&quot; &lt;&gt; fOut</span></span>
<span class="lineno">  243 </span>
<span class="lineno">  244 </span><span class="decl"><span class="istickedoff">addStartupFuncArgs (FunCall (NormalFunCall _ (Args exps))) (FunAssign _ (FunBody names _ _)) = do</span>
<span class="lineno">  245 </span><span class="spaces">    </span><span class="istickedoff">mapM_</span>
<span class="lineno">  246 </span><span class="spaces">        </span><span class="istickedoff">( \case</span>
<span class="lineno">  247 </span><span class="spaces">            </span><span class="istickedoff">(Name name, Number _ valueString, serialNumber) -&gt; addToBuffer name valueString serialNumber</span>
<span class="lineno">  248 </span><span class="spaces">            </span><span class="istickedoff">(Name name, Unop Neg (Number _ valueString), serialNumber) -&gt; addToBuffer name (&quot;-&quot; &lt;&gt; valueString) serialNumber</span>
<span class="lineno">  249 </span><span class="spaces">            </span><span class="istickedoff">_ -&gt; <span class="nottickedoff">error &quot;addStartupFuncArgs: internal error&quot;</span></span>
<span class="lineno">  250 </span><span class="spaces">        </span><span class="istickedoff">)</span>
<span class="lineno">  251 </span><span class="spaces">        </span><span class="istickedoff">$ zip3 names exps [0 ..]</span>
<span class="lineno">  252 </span><span class="spaces">    </span><span class="istickedoff">return <span class="nottickedoff">&quot;&quot;</span></span>
<span class="lineno">  253 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  254 </span><span class="spaces">        </span><span class="istickedoff">addToBuffer name valueString serialNumber = do</span>
<span class="lineno">  255 </span><span class="spaces">            </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algVars, algLatestLuaValueInstance, algStartupArgs} &lt;- get</span>
<span class="lineno">  256 </span><span class="spaces">            </span><span class="istickedoff">let value = LuaValueInstance{lviName = name, lviAssignCount = 0, lviIsConstant = False}</span>
<span class="lineno">  257 </span><span class="spaces">            </span><span class="istickedoff">put luaAlgBuilder{algLatestLuaValueInstance = HM.insert name value algLatestLuaValueInstance, algVars = HM.insert value [] algVars, algStartupArgs = HM.insert serialNumber (name, valueString) algStartupArgs}</span>
<span class="lineno">  258 </span><span class="spaces">            </span><span class="istickedoff">return <span class="nottickedoff">value</span></span>
<span class="lineno">  259 </span><span class="spaces"></span><span class="istickedoff">addStartupFuncArgs _ _ = <span class="nottickedoff">undefined</span></span></span>
<span class="lineno">  260 </span>
<span class="lineno">  261 </span>-- Lua language Stat structure parsing
<span class="lineno">  262 </span>-- LocalAssign
<span class="lineno">  263 </span><span class="decl"><span class="istickedoff">processStatement _ (LocalAssign _names Nothing) = <span class="nottickedoff">do</span></span>
<span class="lineno">  264 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">return ()</span></span>
<span class="lineno">  265 </span><span class="spaces"></span><span class="istickedoff">processStatement fn (LocalAssign names (Just exps)) =</span>
<span class="lineno">  266 </span><span class="spaces">    </span><span class="istickedoff">processStatement <span class="nottickedoff">fn</span> $ Assign (map VarName names) exps</span>
<span class="lineno">  267 </span><span class="spaces"></span><span class="istickedoff">-- Assign</span>
<span class="lineno">  268 </span><span class="spaces"></span><span class="istickedoff">processStatement fn (Assign lexps@[_] [Unop Neg (Number ntype ntext)]) =</span>
<span class="lineno">  269 </span><span class="spaces">    </span><span class="istickedoff">processStatement <span class="nottickedoff">fn</span> (Assign lexps [Number <span class="nottickedoff">ntype</span> (&quot;-&quot; &lt;&gt; ntext)])</span>
<span class="lineno">  270 </span><span class="spaces"></span><span class="istickedoff">processStatement _ (Assign lexp [rexp]) = do</span>
<span class="lineno">  271 </span><span class="spaces">    </span><span class="istickedoff">parseRightExp (map parseLeftExp lexp) rexp</span>
<span class="lineno">  272 </span><span class="spaces"></span><span class="istickedoff">processStatement startupFunctionName (Assign vars exps) | <span class="tickonlytrue">length vars == length exps</span> = do</span>
<span class="lineno">  273 </span><span class="spaces">    </span><span class="istickedoff">mapM_</span>
<span class="lineno">  274 </span><span class="spaces">        </span><span class="istickedoff">( \case</span>
<span class="lineno">  275 </span><span class="spaces">            </span><span class="istickedoff">(VarName (Name name), expr) -&gt; processStatement <span class="nottickedoff">startupFunctionName</span> (Assign [VarName (Name (getTempAlias name))] [expr])</span>
<span class="lineno">  276 </span><span class="spaces">            </span><span class="istickedoff">_ -&gt; <span class="nottickedoff">error &quot;processStatement: internal error&quot;</span></span>
<span class="lineno">  277 </span><span class="spaces">        </span><span class="istickedoff">)</span>
<span class="lineno">  278 </span><span class="spaces">        </span><span class="istickedoff">$ zip vars exps</span>
<span class="lineno">  279 </span><span class="spaces">    </span><span class="istickedoff">mapM_ (\(VarName (Name name)) -&gt; addAlias name (getTempAlias name)) vars</span>
<span class="lineno">  280 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  281 </span><span class="spaces">        </span><span class="istickedoff">getTempAlias name = name &lt;&gt; &quot;&amp;&quot;</span>
<span class="lineno">  282 </span><span class="spaces"></span><span class="istickedoff">-- startup function recursive call</span>
<span class="lineno">  283 </span><span class="spaces"></span><span class="istickedoff">processStatement fn (FunCall (NormalFunCall (PEVar (VarName (Name fName))) (Args args)))</span>
<span class="lineno">  284 </span><span class="spaces">    </span><span class="istickedoff">| fn == fName = do</span>
<span class="lineno">  285 </span><span class="spaces">        </span><span class="istickedoff">LuaAlgBuilder{algStartupArgs} &lt;- get</span>
<span class="lineno">  286 </span><span class="spaces">        </span><span class="istickedoff">let startupVarsNames = map (fromMaybe <span class="nottickedoff">(error &quot;processStatement: internal error&quot;)</span> . (`HM.lookup` algStartupArgs)) [0 .. (HM.size algStartupArgs)]</span>
<span class="lineno">  287 </span><span class="spaces">        </span><span class="istickedoff">let startupVarsVersions = map (\x -&gt; LuaValueInstance{lviName = fst x, lviAssignCount = 0, lviIsConstant = False}) startupVarsNames</span>
<span class="lineno">  288 </span><span class="spaces">        </span><span class="istickedoff">mapM_ parseStartupArg $ zip3 args startupVarsVersions (map (readText . snd) startupVarsNames)</span>
<span class="lineno">  289 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  290 </span><span class="spaces">        </span><span class="istickedoff">parseStartupArg (arg, valueVersion, index) = do</span>
<span class="lineno">  291 </span><span class="spaces">            </span><span class="istickedoff">varName &lt;- parseExpArg &quot;loop&quot; arg</span>
<span class="lineno">  292 </span><span class="spaces">            </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algGraph} &lt;- get</span>
<span class="lineno">  293 </span><span class="spaces">            </span><span class="istickedoff">put luaAlgBuilder{algGraph = LuaStatement{fIn = [varName], fOut = [valueVersion], fValues = [index], fName = &quot;loop&quot;, fInt = []} : algGraph}</span>
<span class="lineno">  294 </span><span class="spaces"></span><span class="istickedoff">processStatement _ (FunCall (NormalFunCall (PEVar (VarName (Name fName))) (Args args))) = do</span>
<span class="lineno">  295 </span><span class="spaces">    </span><span class="istickedoff">fIn &lt;- mapM (parseExpArg &quot;tmp&quot;) args</span>
<span class="lineno">  296 </span><span class="spaces">    </span><span class="istickedoff">addFunction (fromText fName) fIn <span class="nottickedoff">[fromString &quot;&quot;]</span></span>
<span class="lineno">  297 </span><span class="spaces"></span><span class="istickedoff">processStatement _fn (FunCall (NormalFunCall (PEVar (SelectName (PEVar (VarName (Name &quot;debug&quot;))) (Name fName))) (Args args))) = do</span>
<span class="lineno">  298 </span><span class="spaces">    </span><span class="istickedoff">let fIn = map parseTraceArg args</span>
<span class="lineno">  299 </span><span class="spaces">    </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algTraceFuncs, algLatestLuaValueInstance} &lt;- get</span>
<span class="lineno">  300 </span><span class="spaces">    </span><span class="istickedoff">case (fName, fIn) of</span>
<span class="lineno">  301 </span><span class="spaces">        </span><span class="istickedoff">(&quot;trace&quot;, tFmt : vs)</span>
<span class="lineno">  302 </span><span class="spaces">            </span><span class="istickedoff">| T.isPrefixOf &quot;\&quot;&quot; tFmt &amp;&amp; T.isPrefixOf &quot;\&quot;&quot; tFmt -&gt; do</span>
<span class="lineno">  303 </span><span class="spaces">                </span><span class="istickedoff">let vars = map (\x -&gt; T.pack $ takeWhile (/= '#') $ T.unpack $ getUniqueLuaVariableName (fromMaybe <span class="nottickedoff">undefined</span> $ HM.lookup x algLatestLuaValueInstance) 0) vs</span>
<span class="lineno">  304 </span><span class="spaces">                </span><span class="istickedoff">put luaAlgBuilder{algTraceFuncs = (vars, Just $ T.replace &quot;\&quot;&quot; &quot;&quot; tFmt) : algTraceFuncs}</span>
<span class="lineno">  305 </span><span class="spaces">        </span><span class="istickedoff">(&quot;trace&quot;, vs) -&gt; do</span>
<span class="lineno">  306 </span><span class="spaces">            </span><span class="istickedoff">let vars = map (\x -&gt; T.pack $ takeWhile (/= '#') $ T.unpack $ getUniqueLuaVariableName (fromMaybe <span class="nottickedoff">undefined</span> $ HM.lookup x algLatestLuaValueInstance) 0) vs</span>
<span class="lineno">  307 </span><span class="spaces">            </span><span class="istickedoff">put luaAlgBuilder{algTraceFuncs = (vars, Nothing) : algTraceFuncs}</span>
<span class="lineno">  308 </span><span class="spaces">        </span><span class="istickedoff">_ -&gt; <span class="nottickedoff">error $ &quot;unknown debug method: &quot; &lt;&gt; show fName &lt;&gt; &quot; &quot; &lt;&gt; show args</span></span>
<span class="lineno">  309 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  310 </span><span class="spaces">        </span><span class="istickedoff">parseTraceArg (String s) = s</span>
<span class="lineno">  311 </span><span class="spaces">        </span><span class="istickedoff">parseTraceArg (PrefixExp (PEVar (VarName (Name name)))) = name</span>
<span class="lineno">  312 </span><span class="spaces">        </span><span class="istickedoff">parseTraceArg _ = <span class="nottickedoff">undefined</span></span>
<span class="lineno">  313 </span><span class="spaces"></span><span class="istickedoff">processStatement _ _stat = <span class="nottickedoff">error $ &quot;unknown statement: &quot; &lt;&gt; show _stat</span></span></span>
<span class="lineno">  314 </span>
<span class="lineno">  315 </span><span class="decl"><span class="istickedoff">addFunction funcName [i] fOut | toString funcName == &quot;buffer&quot; = do</span>
<span class="lineno">  316 </span><span class="spaces">    </span><span class="istickedoff">addVariable [i] fOut [] &quot;buffer&quot; []</span>
<span class="lineno">  317 </span><span class="spaces"></span><span class="istickedoff">addFunction funcName [i] fOut | toString funcName == &quot;brokenBuffer&quot; = do</span>
<span class="lineno">  318 </span><span class="spaces">    </span><span class="istickedoff">addVariable [i] fOut [] &quot;brokenBuffer&quot; []</span>
<span class="lineno">  319 </span><span class="spaces"></span><span class="istickedoff">addFunction funcName [i] _ | <span class="tickonlytrue">toString funcName == &quot;send&quot;</span> = do</span>
<span class="lineno">  320 </span><span class="spaces">    </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algGraph} &lt;- get</span>
<span class="lineno">  321 </span><span class="spaces">    </span><span class="istickedoff">put luaAlgBuilder{algGraph = LuaStatement{fIn = [i], fOut = [], fValues = [], fName = &quot;send&quot;, fInt = []} : algGraph}</span>
<span class="lineno">  322 </span><span class="spaces"></span><span class="istickedoff">addFunction funcName _ fOut | <span class="tickonlytrue">toString funcName == &quot;receive&quot;</span> = do</span>
<span class="lineno">  323 </span><span class="spaces">    </span><span class="istickedoff">addVariable [] fOut [] &quot;receive&quot; []</span>
<span class="lineno">  324 </span><span class="spaces"></span><span class="istickedoff">addFunction &quot;if_mux&quot; [cond, a, b] [c] = <span class="nottickedoff">do</span></span>
<span class="lineno">  325 </span><span class="spaces">    </span><span class="istickedoff"><span class="nottickedoff">addVariable [cond, a, b] [c] [] &quot;if_mux&quot; []</span></span>
<span class="lineno">  326 </span><span class="spaces"></span><span class="istickedoff">addFunction fName _ _ = <span class="nottickedoff">error $ &quot;unknown function&quot; &lt;&gt; T.unpack fName</span></span></span>
<span class="lineno">  327 </span>
<span class="lineno">  328 </span><span class="decl"><span class="istickedoff">addConstant (Number _valueType valueString) = do</span>
<span class="lineno">  329 </span><span class="spaces">    </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algGraph, algVars, algConstants} &lt;- get</span>
<span class="lineno">  330 </span><span class="spaces">    </span><span class="istickedoff">let lvv = LuaValueInstance{lviName = valueString, lviAssignCount = 0, lviIsConstant = True}</span>
<span class="lineno">  331 </span><span class="spaces">    </span><span class="istickedoff">case HM.lookup valueString algConstants of</span>
<span class="lineno">  332 </span><span class="spaces">        </span><span class="istickedoff">Just value -&gt; do</span>
<span class="lineno">  333 </span><span class="spaces">            </span><span class="istickedoff">let names = fromMaybe <span class="nottickedoff">(error &quot;lua constants parsing error&quot;)</span> $ HM.lookup value algVars</span>
<span class="lineno">  334 </span><span class="spaces">            </span><span class="istickedoff">let resultName = getUniqueLuaVariableName lvv $ length names</span>
<span class="lineno">  335 </span><span class="spaces">            </span><span class="istickedoff">put luaAlgBuilder{algVars = HM.insert value (resultName : names) algVars}</span>
<span class="lineno">  336 </span><span class="spaces">            </span><span class="istickedoff">return resultName</span>
<span class="lineno">  337 </span><span class="spaces">        </span><span class="istickedoff">Nothing -&gt; do</span>
<span class="lineno">  338 </span><span class="spaces">            </span><span class="istickedoff">let resultName = getUniqueLuaVariableName lvv 0</span>
<span class="lineno">  339 </span><span class="spaces">            </span><span class="istickedoff">put</span>
<span class="lineno">  340 </span><span class="spaces">                </span><span class="istickedoff">luaAlgBuilder</span>
<span class="lineno">  341 </span><span class="spaces">                    </span><span class="istickedoff">{ algGraph = LuaStatement{fIn = [], fOut = [lvv], fValues = [readText valueString], fName = &quot;constant&quot;, fInt = []} : algGraph</span>
<span class="lineno">  342 </span><span class="spaces">                    </span><span class="istickedoff">, algVars = HM.insert lvv [resultName] algVars</span>
<span class="lineno">  343 </span><span class="spaces">                    </span><span class="istickedoff">, algConstants = HM.insert valueString lvv algConstants</span>
<span class="lineno">  344 </span><span class="spaces">                    </span><span class="istickedoff">}</span>
<span class="lineno">  345 </span><span class="spaces">            </span><span class="istickedoff">return resultName</span>
<span class="lineno">  346 </span><span class="spaces"></span><span class="istickedoff">addConstant _ = <span class="nottickedoff">undefined</span></span></span>
<span class="lineno">  347 </span>
<span class="lineno">  348 </span><span class="decl"><span class="istickedoff">addVariable fIn fOut fValues fName fInt = do</span>
<span class="lineno">  349 </span><span class="spaces">    </span><span class="istickedoff">LuaAlgBuilder{algLatestLuaValueInstance} &lt;- get</span>
<span class="lineno">  350 </span><span class="spaces">    </span><span class="istickedoff">let luaValueInstances = map (\x -&gt; nameToLuaValueInstance algLatestLuaValueInstance x) fOut</span>
<span class="lineno">  351 </span><span class="spaces">    </span><span class="istickedoff">let func = LuaStatement{fIn, fValues, fName, fInt, fOut = luaValueInstances}</span>
<span class="lineno">  352 </span><span class="spaces">    </span><span class="istickedoff">mapM_ (uncurry addItemToBuffer) $ zip fOut luaValueInstances</span>
<span class="lineno">  353 </span><span class="spaces">    </span><span class="istickedoff">mapM_ addItemToVars luaValueInstances</span>
<span class="lineno">  354 </span><span class="spaces">    </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algGraph, algConstants, algLatestLuaValueInstance = algLatestLuaValueInstance'} &lt;- get</span>
<span class="lineno">  355 </span><span class="spaces">    </span><span class="istickedoff">case fName of</span>
<span class="lineno">  356 </span><span class="spaces">        </span><span class="istickedoff">&quot;constant&quot; -&gt; do</span>
<span class="lineno">  357 </span><span class="spaces">            </span><span class="istickedoff">case HM.lookup (showText $ head fValues) algConstants of</span>
<span class="lineno">  358 </span><span class="spaces">                </span><span class="istickedoff">Just lvv -&gt; do</span>
<span class="lineno">  359 </span><span class="spaces">                    </span><span class="istickedoff">put luaAlgBuilder{algLatestLuaValueInstance = HM.insert (head fOut) lvv algLatestLuaValueInstance'}</span>
<span class="lineno">  360 </span><span class="spaces">                </span><span class="istickedoff">Nothing -&gt; do</span>
<span class="lineno">  361 </span><span class="spaces">                    </span><span class="istickedoff">put luaAlgBuilder{algGraph = func : algGraph, algConstants = HM.insert (showText $ head fValues) (head luaValueInstances) algConstants}</span>
<span class="lineno">  362 </span><span class="spaces">        </span><span class="istickedoff">_ -&gt; do</span>
<span class="lineno">  363 </span><span class="spaces">            </span><span class="istickedoff">put luaAlgBuilder{algGraph = func : algGraph}</span>
<span class="lineno">  364 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  365 </span><span class="spaces">        </span><span class="istickedoff">nameToLuaValueInstance algLatestLuaValueInstance name =</span>
<span class="lineno">  366 </span><span class="spaces">            </span><span class="istickedoff">case getLuaValueByName name algLatestLuaValueInstance of</span>
<span class="lineno">  367 </span><span class="spaces">                </span><span class="istickedoff">Just lvv@LuaValueInstance{lviAssignCount} -&gt; lvv{lviAssignCount = lviAssignCount + 1}</span>
<span class="lineno">  368 </span><span class="spaces">                </span><span class="istickedoff">Nothing -&gt; LuaValueInstance{lviName = name, lviAssignCount = 0, lviIsConstant = False}</span>
<span class="lineno">  369 </span><span class="spaces">        </span><span class="istickedoff">addItemToBuffer name lvv = do</span>
<span class="lineno">  370 </span><span class="spaces">            </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algLatestLuaValueInstance} &lt;- get</span>
<span class="lineno">  371 </span><span class="spaces">            </span><span class="istickedoff">put luaAlgBuilder{algLatestLuaValueInstance = HM.insert name lvv algLatestLuaValueInstance}</span>
<span class="lineno">  372 </span><span class="spaces">        </span><span class="istickedoff">addItemToVars name = do</span>
<span class="lineno">  373 </span><span class="spaces">            </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algVars} &lt;- get</span>
<span class="lineno">  374 </span><span class="spaces">            </span><span class="istickedoff">put luaAlgBuilder{algVars = HM.insert name [] algVars}</span></span>
<span class="lineno">  375 </span>
<span class="lineno">  376 </span><span class="decl"><span class="istickedoff">addVariableAccess name = do</span>
<span class="lineno">  377 </span><span class="spaces">    </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algVars} &lt;- get</span>
<span class="lineno">  378 </span><span class="spaces">    </span><span class="istickedoff">luaValueInstance &lt;- getLatestLuaValueInstanceByName name</span>
<span class="lineno">  379 </span><span class="spaces">    </span><span class="istickedoff">case HM.lookup luaValueInstance algVars of</span>
<span class="lineno">  380 </span><span class="spaces">        </span><span class="istickedoff">Just value -&gt; do</span>
<span class="lineno">  381 </span><span class="spaces">            </span><span class="istickedoff">let len = length value</span>
<span class="lineno">  382 </span><span class="spaces">            </span><span class="istickedoff">let resultName = getUniqueLuaVariableName luaValueInstance len</span>
<span class="lineno">  383 </span><span class="spaces">            </span><span class="istickedoff">put luaAlgBuilder{algVars = HM.insert luaValueInstance (resultName : value) algVars}</span>
<span class="lineno">  384 </span><span class="spaces">            </span><span class="istickedoff">return resultName</span>
<span class="lineno">  385 </span><span class="spaces">        </span><span class="istickedoff">Nothing -&gt; <span class="nottickedoff">error (&quot;variable '&quot; &lt;&gt; show (lviName luaValueInstance) &lt;&gt; &quot; not found. Constants list : &quot; &lt;&gt; show algVars)</span></span></span>
<span class="lineno">  386 </span>
<span class="lineno">  387 </span><span class="decl"><span class="istickedoff">getLatestLuaValueInstanceByName name = do</span>
<span class="lineno">  388 </span><span class="spaces">    </span><span class="istickedoff">LuaAlgBuilder{algLatestLuaValueInstance} &lt;- get</span>
<span class="lineno">  389 </span><span class="spaces">    </span><span class="istickedoff">case HM.lookup name algLatestLuaValueInstance of</span>
<span class="lineno">  390 </span><span class="spaces">        </span><span class="istickedoff">Just value -&gt; return value</span>
<span class="lineno">  391 </span><span class="spaces">        </span><span class="istickedoff">Nothing -&gt; <span class="nottickedoff">error $ &quot;variable not found : '&quot; &lt;&gt; show name &lt;&gt; &quot;'.&quot;</span></span></span>
<span class="lineno">  392 </span>
<span class="lineno">  393 </span><span class="decl"><span class="istickedoff">addAlias from to = do</span>
<span class="lineno">  394 </span><span class="spaces">    </span><span class="istickedoff">luaAlgBuilder@LuaAlgBuilder{algLatestLuaValueInstance} &lt;- get</span>
<span class="lineno">  395 </span><span class="spaces">    </span><span class="istickedoff">case getLuaValueByName to algLatestLuaValueInstance of</span>
<span class="lineno">  396 </span><span class="spaces">        </span><span class="istickedoff">Just value -&gt; do</span>
<span class="lineno">  397 </span><span class="spaces">            </span><span class="istickedoff">put luaAlgBuilder{algLatestLuaValueInstance = HM.insert from value algLatestLuaValueInstance}</span>
<span class="lineno">  398 </span><span class="spaces">        </span><span class="istickedoff">Nothing -&gt; <span class="nottickedoff">error (&quot;variable '&quot; &lt;&gt; show to &lt;&gt; &quot; not found. Constants list : &quot; &lt;&gt; show algLatestLuaValueInstance)</span></span></span>
<span class="lineno">  399 </span>
<span class="lineno">  400 </span><span class="decl"><span class="istickedoff">getLuaValueByName name buffer = HM.lookup name buffer</span></span>
<span class="lineno">  401 </span>
<span class="lineno">  402 </span><span class="decl"><span class="istickedoff">buildAlg syntaxTree =</span>
<span class="lineno">  403 </span><span class="spaces">    </span><span class="istickedoff">flip execState emptyLuaAlgBuilder $ do</span>
<span class="lineno">  404 </span><span class="spaces">        </span><span class="istickedoff">let (startupFunctionName, startupFunctionCall, startupFunctionDef) = findStartupFunction syntaxTree</span>
<span class="lineno">  405 </span><span class="spaces">            </span><span class="istickedoff">statements = funAssignStatements startupFunctionDef</span>
<span class="lineno">  406 </span><span class="spaces">        </span><span class="istickedoff">_ &lt;- addStartupFuncArgs startupFunctionCall startupFunctionDef</span>
<span class="lineno">  407 </span><span class="spaces">        </span><span class="istickedoff">mapM_ (processStatement startupFunctionName) statements</span>
<span class="lineno">  408 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  409 </span><span class="spaces">        </span><span class="istickedoff">emptyLuaAlgBuilder =</span>
<span class="lineno">  410 </span><span class="spaces">            </span><span class="istickedoff">LuaAlgBuilder</span>
<span class="lineno">  411 </span><span class="spaces">                </span><span class="istickedoff">{ algGraph = []</span>
<span class="lineno">  412 </span><span class="spaces">                </span><span class="istickedoff">, algLatestLuaValueInstance = HM.empty</span>
<span class="lineno">  413 </span><span class="spaces">                </span><span class="istickedoff">, algVarCounters = HM.empty</span>
<span class="lineno">  414 </span><span class="spaces">                </span><span class="istickedoff">, algVars = HM.empty</span>
<span class="lineno">  415 </span><span class="spaces">                </span><span class="istickedoff">, algStartupArgs = HM.empty</span>
<span class="lineno">  416 </span><span class="spaces">                </span><span class="istickedoff">, algConstants = HM.empty</span>
<span class="lineno">  417 </span><span class="spaces">                </span><span class="istickedoff">, algTraceFuncs = []</span>
<span class="lineno">  418 </span><span class="spaces">                </span><span class="istickedoff">}</span>
<span class="lineno">  419 </span><span class="spaces">        </span><span class="istickedoff">funAssignStatements (FunAssign _ (FunBody _ _ (Block statements _))) = statements</span>
<span class="lineno">  420 </span><span class="spaces">        </span><span class="istickedoff">funAssignStatements _ = <span class="nottickedoff">error &quot;funAssignStatements : not a function assignment&quot;</span></span></span>
<span class="lineno">  421 </span>
<span class="lineno">  422 </span><span class="decl"><span class="istickedoff">findStartupFunction (Block statements Nothing)</span>
<span class="lineno">  423 </span><span class="spaces">    </span><span class="istickedoff">| [call] &lt;- filter (\case FunCall{} -&gt; True; _ -&gt; False) statements</span>
<span class="lineno">  424 </span><span class="spaces">    </span><span class="istickedoff">, [funAssign] &lt;- filter (\case FunAssign{} -&gt; True; _ -&gt; False) statements</span>
<span class="lineno">  425 </span><span class="spaces">    </span><span class="istickedoff">, (FunCall (NormalFunCall (PEVar (VarName (Name fnCall))) _)) &lt;- call</span>
<span class="lineno">  426 </span><span class="spaces">    </span><span class="istickedoff">, (FunAssign (FunName (Name fnAssign) _ _) _) &lt;- funAssign</span>
<span class="lineno">  427 </span><span class="spaces">    </span><span class="istickedoff">, <span class="tickonlytrue">fnCall == fnAssign</span> =</span>
<span class="lineno">  428 </span><span class="spaces">        </span><span class="istickedoff">(fnCall, call, funAssign)</span>
<span class="lineno">  429 </span><span class="spaces"></span><span class="istickedoff">findStartupFunction _ = <span class="nottickedoff">error &quot;can't find startup function in lua source code&quot;</span></span></span>
<span class="lineno">  430 </span>
<span class="lineno">  431 </span><span class="decl"><span class="istickedoff">getLuaBlockFromSources src = either <span class="nottickedoff">(\e -&gt; error $ &quot;Exception while parsing Lua sources: &quot; &lt;&gt; show e)</span> id $ parseText chunk src</span></span>
<span class="lineno">  432 </span>
<span class="lineno">  433 </span><span class="decl"><span class="istickedoff">alg2graph LuaAlgBuilder{algGraph, algLatestLuaValueInstance, algVars} = flip execState (DFCluster []) $ do</span>
<span class="lineno">  434 </span><span class="spaces">    </span><span class="istickedoff">mapM addToGraph algGraph</span>
<span class="lineno">  435 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  436 </span><span class="spaces">        </span><span class="istickedoff">addToGraph item = do</span>
<span class="lineno">  437 </span><span class="spaces">            </span><span class="istickedoff">graph &lt;- get</span>
<span class="lineno">  438 </span><span class="spaces">            </span><span class="istickedoff">put (addFuncToDataFlowGraph (function2nitta item) graph)</span>
<span class="lineno">  439 </span><span class="spaces">            </span><span class="istickedoff">return $ <span class="nottickedoff">fromString &quot;&quot;</span></span>
<span class="lineno">  440 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;buffer&quot;, fIn = [i], fOut = [o], fValues = [], fInt = []} = F.buffer (fromText i) $ output o</span>
<span class="lineno">  441 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;brokenBuffer&quot;, fIn = [i], fOut = [o], fValues = [], fInt = []} = F.brokenBuffer (fromText i) $ output o</span>
<span class="lineno">  442 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;constant&quot;, fIn = [], fOut = [o], fValues = [x], fInt = []} = F.constant x $ output o</span>
<span class="lineno">  443 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;send&quot;, fIn = [i], fOut = [], fValues = [], fInt = []} = F.send (fromText i)</span>
<span class="lineno">  444 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;add&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = F.add (fromText a) (fromText b) $ output c</span>
<span class="lineno">  445 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;sub&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = F.sub (fromText a) (fromText b) $ output c</span>
<span class="lineno">  446 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;multiply&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = F.multiply (fromText a) (fromText b) $ output c</span>
<span class="lineno">  447 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;divide&quot;, fIn = [d, n], fOut = [q], fValues = [], fInt = []} = F.division (fromText d) (fromText n) (output q) []</span>
<span class="lineno">  448 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;divide&quot;, fIn = [d, n], fOut = [q, r], fValues = [], fInt = []} = F.division (fromText d) (fromText n) (output q) (output r)</span>
<span class="lineno">  449 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;neg&quot;, fIn = [i], fOut = [o], fValues = [], fInt = []} = F.neg (fromText i) $ output o</span>
<span class="lineno">  450 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;receive&quot;, fIn = [], fOut = [o], fValues = [], fInt = []} = F.receive $ output o</span>
<span class="lineno">  451 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;shiftL&quot;, fIn = [a], fOut = [c], fValues = [], fInt = [s]} = F.shiftL s (fromText a) $ output c</span>
<span class="lineno">  452 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;shiftR&quot;, fIn = [a], fOut = [c], fValues = [], fInt = [s]} = F.shiftR s (fromText a) $ output c</span>
<span class="lineno">  453 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;loop&quot;, fIn = [a], fOut = [c], fValues = [x], fInt = []} = F.loop x (fromText a) $ output c</span>
<span class="lineno">  454 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;lessThan&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = <span class="nottickedoff">F.cmp F.CmpLt (fromText a) (fromText b) (output c)</span></span>
<span class="lineno">  455 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;lessThanOrEqual&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = <span class="nottickedoff">F.cmp F.CmpLte (fromText a) (fromText b) $ output c</span></span>
<span class="lineno">  456 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;equal&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = <span class="nottickedoff">F.cmp F.CmpEq (fromText a) (fromText b) $ output c</span></span>
<span class="lineno">  457 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;greaterThanOrEqual&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = <span class="nottickedoff">F.cmp F.CmpGte (fromText a) (fromText b) $ output c</span></span>
<span class="lineno">  458 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;greaterThan&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = <span class="nottickedoff">F.cmp F.CmpGt (fromText a) (fromText b) $ output c</span></span>
<span class="lineno">  459 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;and&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = F.logicAnd (fromText a) (fromText b) $ output c</span>
<span class="lineno">  460 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;or&quot;, fIn = [a, b], fOut = [c], fValues = [], fInt = []} = F.logicOr (fromText a) (fromText b) $ output c</span>
<span class="lineno">  461 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;not&quot;, fIn = [a], fOut = [c], fValues = [], fInt = []} = <span class="nottickedoff">F.logicNot (fromText a) $ output c</span></span>
<span class="lineno">  462 </span><span class="spaces">        </span><span class="istickedoff">function2nitta LuaStatement{fName = &quot;if_mux&quot;, fIn = [cond, b, a], fOut = [c], fValues = [], fInt = []} = <span class="nottickedoff">F.mux [fromText a, fromText b] (fromText cond) $ output c</span></span>
<span class="lineno">  463 </span><span class="spaces">        </span><span class="istickedoff">function2nitta f = <span class="nottickedoff">error $ &quot;function not found: &quot; &lt;&gt; show f</span></span>
<span class="lineno">  464 </span><span class="spaces">        </span><span class="istickedoff">output v =</span>
<span class="lineno">  465 </span><span class="spaces">            </span><span class="istickedoff">case HM.lookup v algVars of</span>
<span class="lineno">  466 </span><span class="spaces">                </span><span class="istickedoff">Just names -&gt; map fromText names</span>
<span class="lineno">  467 </span><span class="spaces">                </span><span class="istickedoff">_ -&gt; <span class="nottickedoff">error $ &quot;variable not found : &quot; &lt;&gt; show v &lt;&gt; &quot;, buffer : &quot; &lt;&gt; show algLatestLuaValueInstance</span></span></span>
<span class="lineno">  468 </span>
<span class="lineno">  469 </span>translateLua :: (Var v, Val x) =&gt; T.Text -&gt; FrontendResult v x
<span class="lineno">  470 </span><span class="decl"><span class="istickedoff">translateLua src =</span>
<span class="lineno">  471 </span><span class="spaces">    </span><span class="istickedoff">let syntaxTree = getLuaBlockFromSources src</span>
<span class="lineno">  472 </span><span class="spaces">        </span><span class="istickedoff">luaAlgBuilder = buildAlg syntaxTree</span>
<span class="lineno">  473 </span><span class="spaces">        </span><span class="istickedoff">frTrace = getFrTrace $ getAllTraceFuncs luaAlgBuilder</span>
<span class="lineno">  474 </span><span class="spaces">     </span><span class="istickedoff">in FrontendResult{frDataFlow = alg2graph luaAlgBuilder, <span class="nottickedoff">frTrace</span>, frPrettyLog = prettyLog frTrace}</span>
<span class="lineno">  475 </span><span class="spaces">    </span><span class="istickedoff">where</span>
<span class="lineno">  476 </span><span class="spaces">        </span><span class="istickedoff">getAllTraceFuncs algBuilder =</span>
<span class="lineno">  477 </span><span class="spaces">            </span><span class="istickedoff">let traceFuncs = algTraceFuncs algBuilder</span>
<span class="lineno">  478 </span><span class="spaces">                </span><span class="istickedoff">startupArgNames =</span>
<span class="lineno">  479 </span><span class="spaces">                    </span><span class="istickedoff">map</span>
<span class="lineno">  480 </span><span class="spaces">                        </span><span class="istickedoff">(\(_idx, (varName, _initValue)) -&gt; varName)</span>
<span class="lineno">  481 </span><span class="spaces">                        </span><span class="istickedoff">$ HM.toList</span>
<span class="lineno">  482 </span><span class="spaces">                        </span><span class="istickedoff">$ algStartupArgs algBuilder</span>
<span class="lineno">  483 </span><span class="spaces">             </span><span class="istickedoff">in map (\name -&gt; ([name &lt;&gt; &quot;^0&quot;], Nothing)) startupArgNames &lt;&gt; traceFuncs</span></span>
<span class="lineno">  484 </span>
<span class="lineno">  485 </span><span class="decl"><span class="istickedoff">getFrTrace traceFuncs = [TraceVar fmt var | (vars, fmt) &lt;- traceFuncs, var &lt;- vars]</span></span>

</pre>
</body>
</html>
